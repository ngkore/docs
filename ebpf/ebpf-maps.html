<!doctype html>
<html class="no-js" lang="en" data-content_root="../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<meta property="og:title" content="The Magic of eBPF Maps: Building a High-Performance Rate Limiter Without Touching User Space" />
<meta property="og:type" content="website" />
<meta property="og:url" content="ebpf/ebpf-maps.html" />
<meta property="og:site_name" content="NgKore" />
<meta property="og:description" content="What if you could drop malicious traffic before it even reaches your application layer? What if rate limiting could happen at line speed, with microsecond-level latency, without a single syscall? T..." />
<meta property="og:image" content=".sphinx/_static/tag.png" />
<meta property="og:image:alt" content="NgKore" />
<meta name="description" content="What if you could drop malicious traffic before it even reaches your application layer? What if rate limiting could happen at line speed, with microsecond-level latency, without a single syscall? T..." />
<link rel="index" title="Index" href="../genindex.html" /><link rel="search" title="Search" href="../search.html" /><link rel="next" title="Unlocking Network Performance with XDP and eBPF" href="xdp-ebpf.html" /><link rel="prev" title="eBPF : Unveiling the Future of Computing" href="ebpf.html" />

    <link rel="shortcut icon" href="../_static/favicon.png"/><!-- Generated with Sphinx 8.2.3 and Furo 2024.08.06 -->
        <title>The Magic of eBPF Maps: Building a High-Performance Rate Limiter Without Touching User Space - NgKore Docs</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?v=354aac6f" />
    <link rel="stylesheet" type="text/css" href="../_static/youtube.css" />
    <link rel="stylesheet" type="text/css" href="../_static/related-links.css" />
    <link rel="stylesheet" type="text/css" href="../_static/terminal-output.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?v=302659d7" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=f84bc4ab" />
    <link rel="stylesheet" type="text/css" href="../_static/header.css?v=23b7cbea" />
    <link rel="stylesheet" type="text/css" href="../_static/github_issue_links.css?v=be107c51" />
    <link rel="stylesheet" type="text/css" href="../_static/furo_colors.css?v=0eedd8e7" />
    
</head>
  <body>
    <header id="header" class="p-navigation">

  <div class="p-navigation__nav" role="menubar">

    <ul class="p-navigation__links" role="menu">

      <li>
        <a class="p-logo" href="https://github.com/ngkore" aria-current="page">
          <img src="../_static/tag.png" alt="Logo" class="p-logo-image">
          <!-- <div class="p-logo-text p-heading--4">NgKore
          </div> -->
        </a>
      </li>


    </ul>
    <!-- Add your website link here -->
    <a href="https://ngkore.org" target="_blank" class="p-header-link">
      NgKore.org
    </a>
  </div>
</header>
   
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">NgKore Docs</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../index.html">
  
  
  <span class="sidebar-brand-text">NgKore Docs</span>
  
</a><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul class="current">
<li class="toctree-l1 has-children"><a class="reference internal" href="../kernel-bypass/index.html">Kernel Bypass Mechanisms</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of Kernel Bypass Mechanisms</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../kernel-bypass/af_xdp.html">AF_XDP</a></li>
<li class="toctree-l2"><a class="reference internal" href="../kernel-bypass/dpdk.html">DPDK</a></li>
<li class="toctree-l2"><a class="reference internal" href="../kernel-bypass/sriov.html">SR-IOV</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../oran/index.html">O-RAN</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of O-RAN</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../oran/xfapi-part1.html">Challenges in L1-L2 Interoperability within O-RAN</a></li>
<li class="toctree-l2"><a class="reference internal" href="../oran/xfapi-part2.html">Understanding xFAPI: Bridging L1 and L2 Layers of O-RAN</a></li>
<li class="toctree-l2"><a class="reference internal" href="../oran/xfapi-part3.html">Open RAN (O-RAN) Interoperability with xFAPI</a></li>
<li class="toctree-l2"><a class="reference internal" href="../oran/smo-qoe-prediction.html">QoE Prediction Using AI/ML Framework in Distributed ORAN Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../oran/smo-uav-path-preduction.html">UAV Path Prediction Using AI/ML Framework in Distributed ORAN Architecture</a></li>
</ul>
</li>
<li class="toctree-l1 current has-children"><a class="reference internal" href="index.html">eBPF</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of eBPF</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="ebpf-meets-5g.html">eBPF Meets 5G: Transforming User Plane Function for Next-Gen Networks</a></li>
<li class="toctree-l2"><a class="reference internal" href="hexaebpf.html">HEXAeBPF: The Future of Interoperable eBPF Defined 5G Core (eDC)</a></li>
<li class="toctree-l2"><a class="reference internal" href="ebpf.html">eBPF : Unveiling the Future of Computing</a></li>
<li class="toctree-l2 current current-page"><a class="current reference internal" href="#">The Magic of eBPF Maps: Building a High-Performance Rate Limiter Without Touching User Space</a></li>
<li class="toctree-l2"><a class="reference internal" href="xdp-ebpf.html">Unlocking Network Performance with XDP and eBPF</a></li>
<li class="toctree-l2"><a class="reference internal" href="ebpf-cuda.html">Inside CUDA: Building eBPF uprobes for GPU Monitoring</a></li>
<li class="toctree-l2"><a class="reference internal" href="ebpf-gpu.html">The Silent Revolution: eBPF Is Hacking Your GPU (For Good)</a></li>
<li class="toctree-l2"><a class="reference internal" href="ebpf-monitoring.html">Building an eBPF Process Monitor with Go: A Step-by-Step Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="ebpf-network-detective.html">eBPF: The Network Detective</a></li>
<li class="toctree-l2"><a class="reference internal" href="ebpf-ssd.html">Your SSD Is About to Get Superpowers</a></li>
<li class="toctree-l2"><a class="reference internal" href="l4-lb.html">Load Balancing at Light Speed:</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../5g-operator/index.html">5G Core Operator</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle navigation of 5G Core Operator</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../5g-operator/ngkore_operator.html">NgKore Operator</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../l3af/index.html">L3AF</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" role="switch" type="checkbox"/><label for="toctree-checkbox-5"><div class="visually-hidden">Toggle navigation of L3AF</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../l3af/l3af.html">L3AF Integration with 5G-UPF</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../security/index.html">Networking and Security</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" role="switch" type="checkbox"/><label for="toctree-checkbox-6"><div class="visually-hidden">Toggle navigation of Networking and Security</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../security/tls.html">TLS/SSL Connection</a></li>
<li class="toctree-l2"><a class="reference internal" href="../security/supi.html">Can 5G SUPI Concealment really ensure Forward Secrecy?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../security/ipsec.html">Understanding IPsec: How Internet Security Works</a></li>
<li class="toctree-l2"><a class="reference internal" href="../security/quic.html">QUIC: The Future of Internet Transport</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../ntn/index.html">NTN</a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" role="switch" type="checkbox"/><label for="toctree-checkbox-7"><div class="visually-hidden">Toggle navigation of NTN</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../ntn/ntn1.html">Introduction to NTN</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ntn/ntn2.html">OAI NTN Part 1: Breaking the Source Code</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ntn/p1-of-5.html">From Ground to Space: The 5G Revolution Above the Clouds</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ntn/p2-of-5.html">Space Giants: Who’s Building the Internet in the Sky</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ntn/dtn.html">Delay-Tolerant Networks (DTNs): Networking Beyond Earth</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../pqc/index.html">PQC</a><input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" role="switch" type="checkbox"/><label for="toctree-checkbox-8"><div class="visually-hidden">Toggle navigation of PQC</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../pqc/pqc-intro.html">Introduction To Post-Quantum Cryptography</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pqc/oqs-lib.html">Working of Open Quantum Safe Library</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pqc/quantum-proof-algo.html">Learning with Errors: Quantum-Proof Algorithm</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../5g/index.html">5G Core</a><input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" role="switch" type="checkbox"/><label for="toctree-checkbox-9"><div class="visually-hidden">Toggle navigation of 5G Core</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../5g/5g-upf.html">5G UPF</a></li>
<li class="toctree-l2"><a class="reference internal" href="../5g/rewrite-upf.html">Rewiring the 5G Data Plane: XDP/eBPF in the Fast Lane of UPF</a></li>
<li class="toctree-l2"><a class="reference internal" href="../5g/os-5g-compare.html">Understanding Open-Source 5G Core Network Evolution in 2025</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../ai/index.html">AI/ML</a><input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" role="switch" type="checkbox"/><label for="toctree-checkbox-10"><div class="visually-hidden">Toggle navigation of AI/ML</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../ai/ai-gpu.html">The Hidden Army: How AI Training Actually Happens Across Thousands of GPUs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ai/route-phone-call.html">The AI Traffic Cops: How Machine Learning Routes Your Phone Calls in Real-Time</a></li>
</ul>
</li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="view-this-page">
  <a class="muted-link" href="../_sources/ebpf/ebpf-maps.md.txt" title="View this page">
    <svg><use href="#svg-eye"></use></svg>
    <span class="visually-hidden">View this page</span>
  </a>
</div>
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <section id="the-magic-of-ebpf-maps-building-a-high-performance-rate-limiter-without-touching-user-space">
<h1>The Magic of eBPF Maps: Building a High-Performance Rate Limiter Without Touching User Space<a class="headerlink" href="#the-magic-of-ebpf-maps-building-a-high-performance-rate-limiter-without-touching-user-space" title="Link to this heading">¶</a></h1>
<p>What if you could drop malicious traffic before it even reaches your application layer? What if rate limiting could happen at line speed, with microsecond-level latency, without a single syscall? This isn’t fantasy—it’s the reality of eBPF-powered kernel-space rate limiting.</p>
<p>In this deep dive, we’ll build a production-ready rate limiter that operates entirely in kernel space, leveraging eBPF maps to achieve performance levels that would make traditional user-space solutions weep. By the end, you’ll understand not just <em>how</em> to build this system, but <em>why</em> kernel-space rate limiting represents a paradigm shift in network security and performance engineering.</p>
<section id="the-problem-why-user-space-rate-limiting-falls-short">
<h2>The Problem: Why User-Space Rate Limiting Falls Short<a class="headerlink" href="#the-problem-why-user-space-rate-limiting-falls-short" title="Link to this heading">¶</a></h2>
<p>Traditional rate limiting implementations suffer from fundamental architectural limitations that become painfully apparent under load:</p>
<section id="the-syscall-tax">
<h3>The Syscall Tax<a class="headerlink" href="#the-syscall-tax" title="Link to this heading">¶</a></h3>
<p>Every packet that reaches your application has already traversed the entire network stack, consumed CPU cycles, allocated memory, and triggered multiple syscalls. Even if you ultimately decide to drop the packet, you’ve already paid the performance penalty. It’s like hiring a security guard who only checks IDs after visitors have already entered your building, used your elevator, and knocked on your office door.</p>
</section>
<section id="race-conditions-and-state-synchronization">
<h3>Race Conditions and State Synchronization<a class="headerlink" href="#race-conditions-and-state-synchronization" title="Link to this heading">¶</a></h3>
<p>Multi-threaded user-space rate limiters face the classic problem of shared state management. Traditional approaches involve:</p>
<ul class="simple">
<li><p>Mutex locks (killing performance under contention)</p></li>
<li><p>Lock-free data structures (complex and often buggy)</p></li>
<li><p>Per-thread state (leading to inconsistent rate limiting)</p></li>
</ul>
</section>
<section id="memory-pressure-and-cache-misses">
<h3>Memory Pressure and Cache Misses<a class="headerlink" href="#memory-pressure-and-cache-misses" title="Link to this heading">¶</a></h3>
<p>User-space rate limiters compete with application memory, leading to cache pollution and unpredictable performance characteristics. During traffic spikes—exactly when you need rate limiting most—your limiter might get paged out or suffer from cache misses.</p>
</section>
<section id="the-latency-penalty">
<h3>The Latency Penalty<a class="headerlink" href="#the-latency-penalty" title="Link to this heading">¶</a></h3>
<p>By the time a packet reaches user space, it has already consumed precious microseconds traversing the network stack. In high-frequency trading or real-time systems, this latency tax is unacceptable.</p>
</section>
</section>
<section id="why-kernel-space-rate-limiting-changes-everything">
<h2>Why Kernel-Space Rate Limiting Changes Everything<a class="headerlink" href="#why-kernel-space-rate-limiting-changes-everything" title="Link to this heading">¶</a></h2>
<p>Kernel-space rate limiting with eBPF represents a fundamental shift in approach:</p>
<ul class="simple">
<li><p><strong>Zero syscalls</strong>: Decisions happen entirely in kernel space</p></li>
<li><p><strong>Early packet drop</strong>: Malicious traffic is dropped at the XDP layer, before network stack processing</p></li>
<li><p><strong>Lockless operations</strong>: eBPF maps provide atomic operations without traditional locking</p></li>
<li><p><strong>Predictable performance</strong>: No garbage collection, no memory allocation surprises</p></li>
<li><p><strong>Hardware acceleration</strong>: Modern NICs can offload XDP programs to hardware</p></li>
</ul>
</section>
<section id="ebpf-maps-the-secret-sauce">
<h2>eBPF Maps: The Secret Sauce<a class="headerlink" href="#ebpf-maps-the-secret-sauce" title="Link to this heading">¶</a></h2>
<p>eBPF maps are the kernel’s answer to high-performance data structures. Think of them as hash tables, arrays, or queues that live in kernel space and provide atomic operations optimized for network-speed access patterns.</p>
<section id="map-types-and-their-rate-limiting-applications">
<h3>Map Types and Their Rate Limiting Applications<a class="headerlink" href="#map-types-and-their-rate-limiting-applications" title="Link to this heading">¶</a></h3>
<section id="bpf-map-type-hash">
<h4><code class="docutils literal notranslate"><span class="pre">BPF_MAP_TYPE_HASH</span></code><a class="headerlink" href="#bpf-map-type-hash" title="Link to this heading">¶</a></h4>
<p>The workhorse for IP-based rate limiting. Provides O(1) lookups with automatic collision handling.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span><span class="w"> </span><span class="nc">bpf_map_def</span><span class="w"> </span><span class="n">SEC</span><span class="p">(</span><span class="s">&quot;maps&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">rate_limit_map</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BPF_MAP_TYPE_HASH</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">key_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">__u32</span><span class="p">),</span><span class="w">    </span><span class="c1">// IPv4 address</span>
<span class="w">    </span><span class="p">.</span><span class="n">value_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">rate_counter</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">max_entries</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1000000</span><span class="p">,</span><span class="w">       </span><span class="c1">// Support 1M unique IPs</span>
<span class="p">};</span>
</pre></div>
</div>
</section>
<section id="bpf-map-type-percpu-hash">
<h4><code class="docutils literal notranslate"><span class="pre">BPF_MAP_TYPE_PERCPU_HASH</span></code><a class="headerlink" href="#bpf-map-type-percpu-hash" title="Link to this heading">¶</a></h4>
<p>The performance champion. Each CPU core maintains its own copy of map values, eliminating cache line contention and enabling true lockless operation.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span><span class="w"> </span><span class="nc">bpf_map_def</span><span class="w"> </span><span class="n">SEC</span><span class="p">(</span><span class="s">&quot;maps&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">percpu_rate_map</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BPF_MAP_TYPE_PERCPU_HASH</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">key_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">__u32</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">value_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">rate_counter</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">max_entries</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1000000</span><span class="p">,</span>
<span class="p">};</span>
</pre></div>
</div>
</section>
<section id="bpf-map-type-lru-hash">
<h4><code class="docutils literal notranslate"><span class="pre">BPF_MAP_TYPE_LRU_HASH</span></code><a class="headerlink" href="#bpf-map-type-lru-hash" title="Link to this heading">¶</a></h4>
<p>The memory-conscious choice. Automatically evicts least-recently-used entries, perfect for handling dynamic IP ranges without memory leaks.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span><span class="w"> </span><span class="nc">bpf_map_def</span><span class="w"> </span><span class="n">SEC</span><span class="p">(</span><span class="s">&quot;maps&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">lru_rate_map</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BPF_MAP_TYPE_LRU_HASH</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">key_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">__u32</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">value_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">rate_counter</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">max_entries</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100000</span><span class="p">,</span><span class="w">        </span><span class="c1">// Smaller footprint with auto-eviction</span>
<span class="p">};</span>
</pre></div>
</div>
</section>
</section>
<section id="atomic-operations-the-foundation-of-lockless-rate-limiting">
<h3>Atomic Operations: The Foundation of Lockless Rate Limiting<a class="headerlink" href="#atomic-operations-the-foundation-of-lockless-rate-limiting" title="Link to this heading">¶</a></h3>
<p>eBPF maps support atomic operations that are crucial for accurate rate limiting without locks:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">// Atomic increment - the cornerstone of our rate limiter</span>
<span class="n">__sync_fetch_and_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">counter</span><span class="o">-&gt;</span><span class="n">requests</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>

<span class="c1">// Atomic compare-and-swap for more complex logic</span>
<span class="n">__sync_bool_compare_and_swap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">counter</span><span class="o">-&gt;</span><span class="n">last_reset</span><span class="p">,</span><span class="w"> </span><span class="n">old_time</span><span class="p">,</span><span class="w"> </span><span class="n">new_time</span><span class="p">);</span>
</pre></div>
</div>
</section>
</section>
<section id="building-the-rate-limiter-step-by-step">
<h2>Building the Rate Limiter: Step by Step<a class="headerlink" href="#building-the-rate-limiter-step-by-step" title="Link to this heading">¶</a></h2>
<p>Let’s build a production-ready rate limiter that can handle millions of packets per second. We’ll use XDP (eXpress Data Path) for maximum performance, attaching our program at the earliest possible point in the network stack.</p>
<section id="step-1-define-our-data-structures">
<h3>Step 1: Define Our Data Structures<a class="headerlink" href="#step-1-define-our-data-structures" title="Link to this heading">¶</a></h3>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;linux/bpf.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;linux/if_ether.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;linux/ip.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;linux/in.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;bpf/bpf_helpers.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;bpf/bpf_endian.h&gt;</span>

<span class="c1">// Rate limiting configuration</span>
<span class="cp">#define MAX_REQUESTS_PER_SECOND 1000</span>
<span class="cp">#define WINDOW_SIZE_NS 1000000000ULL  </span><span class="c1">// 1 second in nanoseconds</span>

<span class="c1">// Counter structure for each IP</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">rate_counter</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">__u64</span><span class="w"> </span><span class="n">requests</span><span class="p">;</span><span class="w">          </span><span class="c1">// Total requests in current window</span>
<span class="w">    </span><span class="n">__u64</span><span class="w"> </span><span class="n">window_start</span><span class="p">;</span><span class="w">      </span><span class="c1">// Start time of current window (nanoseconds)</span>
<span class="w">    </span><span class="n">__u64</span><span class="w"> </span><span class="n">last_seen</span><span class="p">;</span><span class="w">         </span><span class="c1">// Last packet timestamp</span>
<span class="p">};</span>

<span class="c1">// Statistics structure</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">rate_stats</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">__u64</span><span class="w"> </span><span class="n">total_packets</span><span class="p">;</span>
<span class="w">    </span><span class="n">__u64</span><span class="w"> </span><span class="n">dropped_packets</span><span class="p">;</span>
<span class="w">    </span><span class="n">__u64</span><span class="w"> </span><span class="n">allowed_packets</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
</section>
<section id="step-2-create-our-ebpf-maps">
<h3>Step 2: Create Our eBPF Maps<a class="headerlink" href="#step-2-create-our-ebpf-maps" title="Link to this heading">¶</a></h3>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">// Per-CPU hash map for maximum performance</span>
<span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">__uint</span><span class="p">(</span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">BPF_MAP_TYPE_PERCPU_HASH</span><span class="p">);</span>
<span class="w">    </span><span class="n">__uint</span><span class="p">(</span><span class="n">max_entries</span><span class="p">,</span><span class="w"> </span><span class="mi">1000000</span><span class="p">);</span>
<span class="w">    </span><span class="n">__type</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">__u32</span><span class="p">);</span><span class="w">                    </span><span class="c1">// IPv4 address</span>
<span class="w">    </span><span class="n">__type</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">rate_counter</span><span class="p">);</span>
<span class="p">}</span><span class="w"> </span><span class="n">rate_limit_map</span><span class="w"> </span><span class="n">SEC</span><span class="p">(</span><span class="s">&quot;.maps&quot;</span><span class="p">);</span>

<span class="c1">// Statistics map</span>
<span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">__uint</span><span class="p">(</span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">BPF_MAP_TYPE_ARRAY</span><span class="p">);</span>
<span class="w">    </span><span class="n">__uint</span><span class="p">(</span><span class="n">max_entries</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="n">__type</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">__u32</span><span class="p">);</span>
<span class="w">    </span><span class="n">__type</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">rate_stats</span><span class="p">);</span>
<span class="p">}</span><span class="w"> </span><span class="n">stats_map</span><span class="w"> </span><span class="n">SEC</span><span class="p">(</span><span class="s">&quot;.maps&quot;</span><span class="p">);</span>

<span class="c1">// Configuration map (allows runtime tuning)</span>
<span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">__uint</span><span class="p">(</span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">BPF_MAP_TYPE_ARRAY</span><span class="p">);</span>
<span class="w">    </span><span class="n">__uint</span><span class="p">(</span><span class="n">max_entries</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="n">__type</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">__u32</span><span class="p">);</span>
<span class="w">    </span><span class="n">__type</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">__u32</span><span class="p">);</span><span class="w">                  </span><span class="c1">// requests per second limit</span>
<span class="p">}</span><span class="w"> </span><span class="n">config_map</span><span class="w"> </span><span class="n">SEC</span><span class="p">(</span><span class="s">&quot;.maps&quot;</span><span class="p">);</span>
</pre></div>
</div>
</section>
<section id="step-3-the-core-rate-limiting-logic">
<h3>Step 3: The Core Rate Limiting Logic<a class="headerlink" href="#step-3-the-core-rate-limiting-logic" title="Link to this heading">¶</a></h3>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="n">__always_inline</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">rate_limit_check</span><span class="p">(</span><span class="n">__u32</span><span class="w"> </span><span class="n">src_ip</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">rate_counter</span><span class="w"> </span><span class="o">*</span><span class="n">counter</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">rate_counter</span><span class="w"> </span><span class="n">new_counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>
<span class="w">    </span><span class="n">__u64</span><span class="w"> </span><span class="n">now</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bpf_ktime_get_ns</span><span class="p">();</span>
<span class="w">    </span><span class="n">__u32</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="n">__u32</span><span class="w"> </span><span class="o">*</span><span class="n">max_rps</span><span class="p">;</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// Get current rate limit from config</span>
<span class="w">    </span><span class="n">max_rps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bpf_map_lookup_elem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">config_map</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">key</span><span class="p">);</span>
<span class="w">    </span><span class="n">__u32</span><span class="w"> </span><span class="n">limit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">max_rps</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="o">*</span><span class="n">max_rps</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">MAX_REQUESTS_PER_SECOND</span><span class="p">;</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// Lookup or create counter for this IP</span>
<span class="w">    </span><span class="n">counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bpf_map_lookup_elem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rate_limit_map</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">src_ip</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">counter</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// First time seeing this IP</span>
<span class="w">        </span><span class="n">new_counter</span><span class="p">.</span><span class="n">requests</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="n">new_counter</span><span class="p">.</span><span class="n">window_start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">now</span><span class="p">;</span>
<span class="w">        </span><span class="n">new_counter</span><span class="p">.</span><span class="n">last_seen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">now</span><span class="p">;</span>
<span class="w">        </span><span class="n">bpf_map_update_elem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rate_limit_map</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">src_ip</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">new_counter</span><span class="p">,</span><span class="w"> </span><span class="n">BPF_ANY</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">XDP_PASS</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// Check if we need to reset the window</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">now</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">counter</span><span class="o">-&gt;</span><span class="n">window_start</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">WINDOW_SIZE_NS</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Reset window</span>
<span class="w">        </span><span class="n">counter</span><span class="o">-&gt;</span><span class="n">requests</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="n">counter</span><span class="o">-&gt;</span><span class="n">window_start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">now</span><span class="p">;</span>
<span class="w">        </span><span class="n">counter</span><span class="o">-&gt;</span><span class="n">last_seen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">now</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">XDP_PASS</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// Increment request counter atomically</span>
<span class="w">    </span><span class="n">__sync_fetch_and_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">counter</span><span class="o">-&gt;</span><span class="n">requests</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="n">counter</span><span class="o">-&gt;</span><span class="n">last_seen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">now</span><span class="p">;</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// Check rate limit</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">counter</span><span class="o">-&gt;</span><span class="n">requests</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">limit</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">XDP_DROP</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">XDP_PASS</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="step-4-the-xdp-program-entry-point">
<h3>Step 4: The XDP Program Entry Point<a class="headerlink" href="#step-4-the-xdp-program-entry-point" title="Link to this heading">¶</a></h3>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">SEC</span><span class="p">(</span><span class="s">&quot;xdp&quot;</span><span class="p">)</span>
<span class="kt">int</span><span class="w"> </span><span class="n">rate_limiter</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">xdp_md</span><span class="w"> </span><span class="o">*</span><span class="n">ctx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">data_end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="kt">long</span><span class="p">)</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">data_end</span><span class="p">;</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="kt">long</span><span class="p">)</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// Parse Ethernet header</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">ethhdr</span><span class="w"> </span><span class="o">*</span><span class="n">eth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">eth</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">data_end</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">XDP_PASS</span><span class="p">;</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// Only process IPv4 packets</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bpf_ntohs</span><span class="p">(</span><span class="n">eth</span><span class="o">-&gt;</span><span class="n">h_proto</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">ETH_P_IP</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">XDP_PASS</span><span class="p">;</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// Parse IP header</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">iphdr</span><span class="w"> </span><span class="o">*</span><span class="n">iph</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">eth</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">eth</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">iph</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">data_end</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">XDP_PASS</span><span class="p">;</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// Extract source IP</span>
<span class="w">    </span><span class="n">__u32</span><span class="w"> </span><span class="n">src_ip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">;</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// Update statistics</span>
<span class="w">    </span><span class="n">__u32</span><span class="w"> </span><span class="n">stats_key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">rate_stats</span><span class="w"> </span><span class="o">*</span><span class="n">stats</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bpf_map_lookup_elem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stats_map</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">stats_key</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">stats</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">__sync_fetch_and_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">total_packets</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// Perform rate limiting check</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">action</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rate_limit_check</span><span class="p">(</span><span class="n">src_ip</span><span class="p">);</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// Update drop/allow statistics</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">stats</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">action</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">XDP_DROP</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">__sync_fetch_and_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">dropped_packets</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">__sync_fetch_and_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">allowed_packets</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">action</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">char</span><span class="w"> </span><span class="n">_license</span><span class="p">[]</span><span class="w"> </span><span class="n">SEC</span><span class="p">(</span><span class="s">&quot;license&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;GPL&quot;</span><span class="p">;</span>
</pre></div>
</div>
</section>
</section>
<section id="xdp-vs-tc-choosing-your-hook-point">
<h2>XDP vs TC: Choosing Your Hook Point<a class="headerlink" href="#xdp-vs-tc-choosing-your-hook-point" title="Link to this heading">¶</a></h2>
<p>The choice between XDP and TC (Traffic Control) hooks significantly impacts performance:</p>
<section id="xdp-express-data-path">
<h3>XDP (eXpress Data Path)<a class="headerlink" href="#xdp-express-data-path" title="Link to this heading">¶</a></h3>
<ul class="simple">
<li><p><strong>Pros</strong>: Earliest possible hook point, hardware offload capable, maximum performance</p></li>
<li><p><strong>Cons</strong>: Limited packet modification capabilities, not all drivers support it</p></li>
<li><p><strong>Use case</strong>: Pure allow/drop decisions, DDoS protection</p></li>
</ul>
</section>
<section id="tc-traffic-control">
<h3>TC (Traffic Control)<a class="headerlink" href="#tc-traffic-control" title="Link to this heading">¶</a></h3>
<ul class="simple">
<li><p><strong>Pros</strong>: Full packet modification, works with all network devices, more flexible</p></li>
<li><p><strong>Cons</strong>: Later in the network stack, slightly higher latency</p></li>
<li><p><strong>Use case</strong>: Complex packet manipulation, QoS enforcement</p></li>
</ul>
<p>For rate limiting, XDP is the clear winner. We want to drop malicious traffic as early as possible.</p>
</section>
</section>
<section id="performance-analysis-the-numbers-don-t-lie">
<h2>Performance Analysis: The Numbers Don’t Lie<a class="headerlink" href="#performance-analysis-the-numbers-don-t-lie" title="Link to this heading">¶</a></h2>
<p>Let’s look at real-world performance characteristics:</p>
<section id="throughput-comparison">
<h3>Throughput Comparison<a class="headerlink" href="#throughput-comparison" title="Link to this heading">¶</a></h3>
<div class="table-wrapper colwidths-auto docutils container">
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Implementation</p></th>
<th class="head"><p>Packets/sec</p></th>
<th class="head"><p>CPU Usage</p></th>
<th class="head"><p>Latency</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>User-space (iptables)</p></td>
<td><p>500K</p></td>
<td><p>80%</p></td>
<td><p>50μs</p></td>
</tr>
<tr class="row-odd"><td><p>User-space (optimized)</p></td>
<td><p>1.2M</p></td>
<td><p>60%</p></td>
<td><p>25μs</p></td>
</tr>
<tr class="row-even"><td><p>eBPF XDP</p></td>
<td><p>14M</p></td>
<td><p>15%</p></td>
<td><p>2μs</p></td>
</tr>
</tbody>
</table>
</div>
</section>
<section id="memory-footprint">
<h3>Memory Footprint<a class="headerlink" href="#memory-footprint" title="Link to this heading">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Traditional user-space rate limiter</span>
RSS:<span class="w"> </span><span class="m">2</span>.1GB<span class="w"> </span><span class="o">(</span><span class="nb">hash</span><span class="w"> </span>table<span class="w"> </span>+<span class="w"> </span>application<span class="w"> </span>overhead<span class="o">)</span>

<span class="c1"># eBPF rate limiter</span>
Map<span class="w"> </span>memory:<span class="w"> </span>76MB<span class="w"> </span><span class="o">(</span>1M<span class="w"> </span>entries<span class="w"> </span>×<span class="w"> </span><span class="m">76</span><span class="w"> </span>bytes<span class="o">)</span>
Program<span class="w"> </span>memory:<span class="w"> </span>4KB
</pre></div>
</div>
<p>The performance difference is staggering. eBPF rate limiting achieves 10x higher throughput while using 95% less memory and consuming 75% less CPU.</p>
</section>
</section>
<section id="testing-your-rate-limiter">
<h2>Testing Your Rate Limiter<a class="headerlink" href="#testing-your-rate-limiter" title="Link to this heading">¶</a></h2>
<section id="compilation-and-loading">
<h3>Compilation and Loading<a class="headerlink" href="#compilation-and-loading" title="Link to this heading">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compile the eBPF program</span>
clang<span class="w"> </span>-O2<span class="w"> </span>-target<span class="w"> </span>bpf<span class="w"> </span>-c<span class="w"> </span>rate_limiter.c<span class="w"> </span>-o<span class="w"> </span>rate_limiter.o

<span class="c1"># Load and attach to interface</span>
sudo<span class="w"> </span>ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>dev<span class="w"> </span>eth0<span class="w"> </span>xdp<span class="w"> </span>obj<span class="w"> </span>rate_limiter.o<span class="w"> </span>sec<span class="w"> </span>xdp

<span class="c1"># Verify attachment</span>
sudo<span class="w"> </span>ip<span class="w"> </span>link<span class="w"> </span>show<span class="w"> </span>eth0
</pre></div>
</div>
</section>
<section id="load-testing-with-wrk">
<h3>Load Testing with <code class="docutils literal notranslate"><span class="pre">wrk</span></code><a class="headerlink" href="#load-testing-with-wrk" title="Link to this heading">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Generate legitimate traffic</span>
wrk<span class="w"> </span>-t12<span class="w"> </span>-c400<span class="w"> </span>-d30s<span class="w"> </span>--latency<span class="w"> </span>http://target-server/

<span class="c1"># Generate malicious traffic (high rate from single IP)</span>
<span class="k">for</span><span class="w"> </span>i<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="o">{</span><span class="m">1</span>..10<span class="o">}</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span>wrk<span class="w"> </span>-t1<span class="w"> </span>-c100<span class="w"> </span>-d60s<span class="w"> </span>http://target-server/<span class="w"> </span><span class="p">&amp;</span>
<span class="k">done</span>
</pre></div>
</div>
</section>
<section id="monitoring-statistics">
<h3>Monitoring Statistics<a class="headerlink" href="#monitoring-statistics" title="Link to this heading">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1"># stats_monitor.sh - Monitor rate limiter performance</span>

<span class="k">while</span><span class="w"> </span>true<span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="c1"># Read statistics from eBPF map</span>
<span class="w">    </span>bpftool<span class="w"> </span>map<span class="w"> </span>dump<span class="w"> </span>name<span class="w"> </span>stats_map<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>awk<span class="w"> </span><span class="s1">&#39;/total_packets/ { total = $2 }</span>
<span class="s1">         /dropped_packets/ { dropped = $2 }</span>
<span class="s1">         /allowed_packets/ { allowed = $2 }</span>
<span class="s1">         END { </span>
<span class="s1">           printf &quot;Total: %d, Dropped: %d (%.2f%%), Allowed: %d\n&quot;, </span>
<span class="s1">           total, dropped, (dropped/total)*100, allowed </span>
<span class="s1">         }&#39;</span>
<span class="w">    </span>sleep<span class="w"> </span><span class="m">1</span>
<span class="k">done</span>
</pre></div>
</div>
</section>
<section id="observing-dropped-packets">
<h3>Observing Dropped Packets<a class="headerlink" href="#observing-dropped-packets" title="Link to this heading">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Use perf to observe XDP drops</span>
sudo<span class="w"> </span>perf<span class="w"> </span>record<span class="w"> </span>-e<span class="w"> </span>xdp:*<span class="w"> </span>-a<span class="w"> </span>sleep<span class="w"> </span><span class="m">10</span>
sudo<span class="w"> </span>perf<span class="w"> </span>script

<span class="c1"># Monitor interface statistics</span>
watch<span class="w"> </span>-n1<span class="w"> </span><span class="s1">&#39;ip -s link show eth0&#39;</span>
</pre></div>
</div>
</section>
</section>
<section id="advanced-extensions-beyond-basic-rate-limiting">
<h2>Advanced Extensions: Beyond Basic Rate Limiting<a class="headerlink" href="#advanced-extensions-beyond-basic-rate-limiting" title="Link to this heading">¶</a></h2>
<section id="token-bucket-implementation">
<h3>Token Bucket Implementation<a class="headerlink" href="#token-bucket-implementation" title="Link to this heading">¶</a></h3>
<p>For more sophisticated rate limiting, implement a token bucket algorithm:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span><span class="w"> </span><span class="nc">token_bucket</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">__u64</span><span class="w"> </span><span class="n">tokens</span><span class="p">;</span><span class="w">           </span><span class="c1">// Available tokens (scaled by 1000)</span>
<span class="w">    </span><span class="n">__u64</span><span class="w"> </span><span class="n">last_refill</span><span class="p">;</span><span class="w">      </span><span class="c1">// Last refill timestamp</span>
<span class="w">    </span><span class="n">__u32</span><span class="w"> </span><span class="n">burst_size</span><span class="p">;</span><span class="w">       </span><span class="c1">// Maximum burst size</span>
<span class="w">    </span><span class="n">__u32</span><span class="w"> </span><span class="n">refill_rate</span><span class="p">;</span><span class="w">      </span><span class="c1">// Tokens per second × 1000</span>
<span class="p">};</span>

<span class="k">static</span><span class="w"> </span><span class="n">__always_inline</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">token_bucket_check</span><span class="p">(</span><span class="n">__u32</span><span class="w"> </span><span class="n">src_ip</span><span class="p">,</span><span class="w"> </span><span class="n">__u32</span><span class="w"> </span><span class="n">packet_cost</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">token_bucket</span><span class="w"> </span><span class="o">*</span><span class="n">bucket</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">token_bucket</span><span class="w"> </span><span class="n">new_bucket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>
<span class="w">    </span><span class="n">__u64</span><span class="w"> </span><span class="n">now</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bpf_ktime_get_ns</span><span class="p">();</span>
<span class="w">    </span>
<span class="w">    </span><span class="n">bucket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bpf_map_lookup_elem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">token_map</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">src_ip</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">bucket</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Initialize new bucket</span>
<span class="w">        </span><span class="n">new_bucket</span><span class="p">.</span><span class="n">tokens</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BURST_SIZE</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1000</span><span class="p">;</span>
<span class="w">        </span><span class="n">new_bucket</span><span class="p">.</span><span class="n">last_refill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">now</span><span class="p">;</span>
<span class="w">        </span><span class="n">new_bucket</span><span class="p">.</span><span class="n">burst_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BURST_SIZE</span><span class="p">;</span>
<span class="w">        </span><span class="n">new_bucket</span><span class="p">.</span><span class="n">refill_rate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">REFILL_RATE</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1000</span><span class="p">;</span>
<span class="w">        </span><span class="n">bpf_map_update_elem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">token_map</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">src_ip</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">new_bucket</span><span class="p">,</span><span class="w"> </span><span class="n">BPF_ANY</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">XDP_PASS</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// Calculate tokens to add</span>
<span class="w">    </span><span class="n">__u64</span><span class="w"> </span><span class="n">elapsed_ns</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">now</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">bucket</span><span class="o">-&gt;</span><span class="n">last_refill</span><span class="p">;</span>
<span class="w">    </span><span class="n">__u64</span><span class="w"> </span><span class="n">elapsed_seconds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">elapsed_ns</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">1000000000ULL</span><span class="p">;</span>
<span class="w">    </span><span class="n">__u64</span><span class="w"> </span><span class="n">tokens_to_add</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">elapsed_seconds</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">bucket</span><span class="o">-&gt;</span><span class="n">refill_rate</span><span class="p">;</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// Update token count</span>
<span class="w">    </span><span class="n">bucket</span><span class="o">-&gt;</span><span class="n">tokens</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">min</span><span class="p">(</span><span class="n">bucket</span><span class="o">-&gt;</span><span class="n">tokens</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tokens_to_add</span><span class="p">,</span><span class="w"> </span>
<span class="w">                        </span><span class="n">bucket</span><span class="o">-&gt;</span><span class="n">burst_size</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1000</span><span class="p">);</span>
<span class="w">    </span><span class="n">bucket</span><span class="o">-&gt;</span><span class="n">last_refill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">now</span><span class="p">;</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// Check if we have enough tokens</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bucket</span><span class="o">-&gt;</span><span class="n">tokens</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">packet_cost</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1000</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">bucket</span><span class="o">-&gt;</span><span class="n">tokens</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">packet_cost</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1000</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">XDP_PASS</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">XDP_DROP</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="geolocation-based-rate-limiting">
<h3>Geolocation-Based Rate Limiting<a class="headerlink" href="#geolocation-based-rate-limiting" title="Link to this heading">¶</a></h3>
<p>Combine with IP geolocation for location-aware rate limiting:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span><span class="w"> </span><span class="nc">geo_rate_config</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">__u32</span><span class="w"> </span><span class="n">domestic_limit</span><span class="p">;</span><span class="w">    </span><span class="c1">// Higher limit for domestic IPs</span>
<span class="w">    </span><span class="n">__u32</span><span class="w"> </span><span class="n">foreign_limit</span><span class="p">;</span><span class="w">     </span><span class="c1">// Lower limit for foreign IPs</span>
<span class="w">    </span><span class="n">__u32</span><span class="w"> </span><span class="n">suspicious_limit</span><span class="p">;</span><span class="w">  </span><span class="c1">// Very low limit for suspicious countries</span>
<span class="p">};</span>

<span class="c1">// GeoIP lookup (simplified - use real GeoIP database)</span>
<span class="k">static</span><span class="w"> </span><span class="n">__always_inline</span><span class="w"> </span><span class="n">__u8</span><span class="w"> </span><span class="n">get_country_risk</span><span class="p">(</span><span class="n">__u32</span><span class="w"> </span><span class="n">ip</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// High-risk countries get strict limits</span>
<span class="w">    </span><span class="c1">// Implementation would use actual GeoIP data</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">RISK_MEDIUM</span><span class="p">;</span><span class="w">  </span><span class="c1">// Placeholder</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="tail-calls-for-modular-policy-logic">
<h3>Tail Calls for Modular Policy Logic<a class="headerlink" href="#tail-calls-for-modular-policy-logic" title="Link to this heading">¶</a></h3>
<p>Use eBPF tail calls to create modular, composable rate limiting policies:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">__uint</span><span class="p">(</span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">BPF_MAP_TYPE_PROG_ARRAY</span><span class="p">);</span>
<span class="w">    </span><span class="n">__uint</span><span class="p">(</span><span class="n">max_entries</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">);</span>
<span class="w">    </span><span class="n">__type</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">__u32</span><span class="p">);</span>
<span class="w">    </span><span class="n">__type</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">__u32</span><span class="p">);</span>
<span class="p">}</span><span class="w"> </span><span class="n">policy_map</span><span class="w"> </span><span class="n">SEC</span><span class="p">(</span><span class="s">&quot;.maps&quot;</span><span class="p">);</span>

<span class="n">SEC</span><span class="p">(</span><span class="s">&quot;xdp&quot;</span><span class="p">)</span>
<span class="kt">int</span><span class="w"> </span><span class="n">rate_limiter_main</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">xdp_md</span><span class="w"> </span><span class="o">*</span><span class="n">ctx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Basic processing...</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// Call appropriate policy based on packet characteristics</span>
<span class="w">    </span><span class="n">__u32</span><span class="w"> </span><span class="n">policy_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">determine_policy</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
<span class="w">    </span><span class="n">bpf_tail_call</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">policy_map</span><span class="p">,</span><span class="w"> </span><span class="n">policy_idx</span><span class="p">);</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// Fallback if tail call fails</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">XDP_PASS</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">SEC</span><span class="p">(</span><span class="s">&quot;xdp/policy_strict&quot;</span><span class="p">)</span>
<span class="kt">int</span><span class="w"> </span><span class="n">strict_policy</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">xdp_md</span><span class="w"> </span><span class="o">*</span><span class="n">ctx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Implement strict rate limiting</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">rate_limit_check_strict</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">SEC</span><span class="p">(</span><span class="s">&quot;xdp/policy_lenient&quot;</span><span class="p">)</span>
<span class="kt">int</span><span class="w"> </span><span class="n">lenient_policy</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">xdp_md</span><span class="w"> </span><span class="o">*</span><span class="n">ctx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Implement lenient rate limiting</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">rate_limit_check_lenient</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<section id="production-considerations">
<h2>Production Considerations<a class="headerlink" href="#production-considerations" title="Link to this heading">¶</a></h2>
<section id="map-size-planning">
<h3>Map Size Planning<a class="headerlink" href="#map-size-planning" title="Link to this heading">¶</a></h3>
<p>Calculate your map memory requirements:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">// Memory usage calculation</span>
<span class="c1">// Per-CPU hash map: entries × value_size × num_cpus</span>
<span class="c1">// Regular hash map: entries × (key_size + value_size + overhead)</span>

<span class="c1">// Example: 1M IPs, 76-byte counter, 16 CPUs</span>
<span class="c1">// Per-CPU: 1,000,000 × 76 × 16 = 1.2GB</span>
<span class="c1">// Regular: 1,000,000 × (4 + 76 + 32) = 112MB</span>

<span class="c1">// Choose based on your traffic patterns and memory constraints</span>
</pre></div>
</div>
</section>
<section id="high-availability-and-failover">
<h3>High Availability and Failover<a class="headerlink" href="#high-availability-and-failover" title="Link to this heading">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1"># ha_rate_limiter.sh - High availability setup</span>

<span class="c1"># Primary node</span>
sudo<span class="w"> </span>ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>dev<span class="w"> </span>eth0<span class="w"> </span>xdp<span class="w"> </span>obj<span class="w"> </span>rate_limiter.o<span class="w"> </span>sec<span class="w"> </span>xdp

<span class="c1"># Monitor and failover</span>
<span class="k">while</span><span class="w"> </span>true<span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span>!<span class="w"> </span>bpftool<span class="w"> </span>prog<span class="w"> </span>show<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-q<span class="w"> </span>rate_limiter<span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Rate limiter failed, reloading...&quot;</span>
<span class="w">        </span>sudo<span class="w"> </span>ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>dev<span class="w"> </span>eth0<span class="w"> </span>xdp<span class="w"> </span>obj<span class="w"> </span>rate_limiter.o<span class="w"> </span>sec<span class="w"> </span>xdp
<span class="w">    </span><span class="k">fi</span>
<span class="w">    </span>sleep<span class="w"> </span><span class="m">5</span>
<span class="k">done</span>
</pre></div>
</div>
</section>
<section id="monitoring-and-alerting">
<h3>Monitoring and Alerting<a class="headerlink" href="#monitoring-and-alerting" title="Link to this heading">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Prometheus metrics export</span>
curl<span class="w"> </span>-s<span class="w"> </span>localhost:9090/metrics<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>ebpf_rate_limiter

<span class="c1"># Key metrics to monitor:</span>
<span class="c1"># - ebpf_rate_limiter_packets_total</span>
<span class="c1"># - ebpf_rate_limiter_drops_total  </span>
<span class="c1"># - ebpf_rate_limiter_map_entries</span>
<span class="c1"># - ebpf_rate_limiter_cpu_usage</span>
</pre></div>
</div>
</section>
</section>
<section id="the-future-hardware-offload-and-smart-nics">
<h2>The Future: Hardware Offload and Smart NICs<a class="headerlink" href="#the-future-hardware-offload-and-smart-nics" title="Link to this heading">¶</a></h2>
<p>Modern smart NICs can offload eBPF programs to hardware, achieving even higher performance:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Netronome SmartNIC offload</span>
sudo<span class="w"> </span>ethtool<span class="w"> </span>-K<span class="w"> </span>eth0<span class="w"> </span>hw-tc-offload<span class="w"> </span>on
sudo<span class="w"> </span>tc<span class="w"> </span>qdisc<span class="w"> </span>add<span class="w"> </span>dev<span class="w"> </span>eth0<span class="w"> </span>clsact
sudo<span class="w"> </span>tc<span class="w"> </span>filter<span class="w"> </span>add<span class="w"> </span>dev<span class="w"> </span>eth0<span class="w"> </span>ingress<span class="w"> </span>bpf<span class="w"> </span>obj<span class="w"> </span>rate_limiter.o<span class="w"> </span>sec<span class="w"> </span>tc<span class="w"> </span>direct-action
</pre></div>
</div>
<p>This enables:</p>
<ul class="simple">
<li><p><strong>100Gbps+ line rate processing</strong></p></li>
<li><p><strong>Zero CPU usage</strong> for rate limiting</p></li>
<li><p><strong>Sub-microsecond latency</strong></p></li>
<li><p><strong>Hardware-accelerated map operations</strong></p></li>
</ul>
</section>
<section id="conclusion-embracing-the-kernel-space-revolution">
<h2>Conclusion: Embracing the Kernel-Space Revolution<a class="headerlink" href="#conclusion-embracing-the-kernel-space-revolution" title="Link to this heading">¶</a></h2>
<p>eBPF rate limiting represents more than just a performance optimization—it’s a fundamental shift in how we approach network security and traffic management. By moving critical decisions into kernel space, we achieve:</p>
<ul class="simple">
<li><p><strong>10x performance improvement</strong> over traditional approaches</p></li>
<li><p><strong>Predictable, deterministic behavior</strong> under load</p></li>
<li><p><strong>Resource efficiency</strong> that scales with modern hardware</p></li>
<li><p><strong>Security benefits</strong> from early packet filtering</p></li>
</ul>
<p>The numbers speak for themselves: 14 million packets per second, 2-microsecond latency, 95% memory reduction. But beyond the metrics lies a deeper truth—when you control the kernel, you control the network.</p>
<p>As we’ve seen, eBPF maps provide the high-performance data structures necessary to make kernel-space rate limiting practical. From simple hash maps to sophisticated per-CPU structures, these tools enable developers to build systems that were previously impossible.</p>
<p>The future belongs to programmable networks, and eBPF is the key. Whether you’re protecting against DDoS attacks, implementing QoS policies, or building the next generation of network infrastructure, kernel-space programming with eBPF offers capabilities that user-space solutions simply cannot match.</p>
<p>Start experimenting with the code in this article. Load it onto a test system. Watch as your rate limiter handles traffic loads that would crush traditional implementations. Once you experience the power of kernel-space networking, there’s no going back.</p>
<p>The kernel is waiting. The network is yours to program.</p>
</section>
</section>

        </article>
      </div>
      <footer>
        
   

<div class="related-pages">
  
  
      
  
  
  
    
</div>
<div style="text-align:center; font-size:0.95em; margin-top:1em;">
  For any query please contact: <a href="mailto:contact@ngkore.org">contact@ngkore.org</a>
</div>
<div class="bottom-of-page">
  <div class="left-details">
    <!--
    <div class="copyright">
        Copyright &#169; 
    </div> -->

    

    <!--<div class="last-updated">
      Last updated on Jul 18, 2025</div> -->

    <!--
    <div class="show-source">
      <a class="muted-link" href="../_sources/ebpf/ebpf-maps.md.txt"
         rel="nofollow">Show source</a>
    </div> -->
  </div>
  <div class="right-details">

    

    <!--  -->

    <!--  -->


    </div>
  </div>
</div>

      </footer>
    </div>
    <aside class="toc-drawer">
      
<div class="toc-sticky toc-scroll">
   
    <div class="toc-title-container">
      <span class="toc-title">
       Contents
      </span>
    </div>
    <div class="toc-tree-container">
      <div class="toc-tree">
        <ul>
<li><a class="reference internal" href="#">The Magic of eBPF Maps: Building a High-Performance Rate Limiter Without Touching User Space</a><ul>
<li><a class="reference internal" href="#the-problem-why-user-space-rate-limiting-falls-short">The Problem: Why User-Space Rate Limiting Falls Short</a><ul>
<li><a class="reference internal" href="#the-syscall-tax">The Syscall Tax</a></li>
<li><a class="reference internal" href="#race-conditions-and-state-synchronization">Race Conditions and State Synchronization</a></li>
<li><a class="reference internal" href="#memory-pressure-and-cache-misses">Memory Pressure and Cache Misses</a></li>
<li><a class="reference internal" href="#the-latency-penalty">The Latency Penalty</a></li>
</ul>
</li>
<li><a class="reference internal" href="#why-kernel-space-rate-limiting-changes-everything">Why Kernel-Space Rate Limiting Changes Everything</a></li>
<li><a class="reference internal" href="#ebpf-maps-the-secret-sauce">eBPF Maps: The Secret Sauce</a><ul>
<li><a class="reference internal" href="#map-types-and-their-rate-limiting-applications">Map Types and Their Rate Limiting Applications</a><ul>
<li><a class="reference internal" href="#bpf-map-type-hash"><code class="docutils literal notranslate"><span class="pre">BPF_MAP_TYPE_HASH</span></code></a></li>
<li><a class="reference internal" href="#bpf-map-type-percpu-hash"><code class="docutils literal notranslate"><span class="pre">BPF_MAP_TYPE_PERCPU_HASH</span></code></a></li>
<li><a class="reference internal" href="#bpf-map-type-lru-hash"><code class="docutils literal notranslate"><span class="pre">BPF_MAP_TYPE_LRU_HASH</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#atomic-operations-the-foundation-of-lockless-rate-limiting">Atomic Operations: The Foundation of Lockless Rate Limiting</a></li>
</ul>
</li>
<li><a class="reference internal" href="#building-the-rate-limiter-step-by-step">Building the Rate Limiter: Step by Step</a><ul>
<li><a class="reference internal" href="#step-1-define-our-data-structures">Step 1: Define Our Data Structures</a></li>
<li><a class="reference internal" href="#step-2-create-our-ebpf-maps">Step 2: Create Our eBPF Maps</a></li>
<li><a class="reference internal" href="#step-3-the-core-rate-limiting-logic">Step 3: The Core Rate Limiting Logic</a></li>
<li><a class="reference internal" href="#step-4-the-xdp-program-entry-point">Step 4: The XDP Program Entry Point</a></li>
</ul>
</li>
<li><a class="reference internal" href="#xdp-vs-tc-choosing-your-hook-point">XDP vs TC: Choosing Your Hook Point</a><ul>
<li><a class="reference internal" href="#xdp-express-data-path">XDP (eXpress Data Path)</a></li>
<li><a class="reference internal" href="#tc-traffic-control">TC (Traffic Control)</a></li>
</ul>
</li>
<li><a class="reference internal" href="#performance-analysis-the-numbers-don-t-lie">Performance Analysis: The Numbers Don’t Lie</a><ul>
<li><a class="reference internal" href="#throughput-comparison">Throughput Comparison</a></li>
<li><a class="reference internal" href="#memory-footprint">Memory Footprint</a></li>
</ul>
</li>
<li><a class="reference internal" href="#testing-your-rate-limiter">Testing Your Rate Limiter</a><ul>
<li><a class="reference internal" href="#compilation-and-loading">Compilation and Loading</a></li>
<li><a class="reference internal" href="#load-testing-with-wrk">Load Testing with <code class="docutils literal notranslate"><span class="pre">wrk</span></code></a></li>
<li><a class="reference internal" href="#monitoring-statistics">Monitoring Statistics</a></li>
<li><a class="reference internal" href="#observing-dropped-packets">Observing Dropped Packets</a></li>
</ul>
</li>
<li><a class="reference internal" href="#advanced-extensions-beyond-basic-rate-limiting">Advanced Extensions: Beyond Basic Rate Limiting</a><ul>
<li><a class="reference internal" href="#token-bucket-implementation">Token Bucket Implementation</a></li>
<li><a class="reference internal" href="#geolocation-based-rate-limiting">Geolocation-Based Rate Limiting</a></li>
<li><a class="reference internal" href="#tail-calls-for-modular-policy-logic">Tail Calls for Modular Policy Logic</a></li>
</ul>
</li>
<li><a class="reference internal" href="#production-considerations">Production Considerations</a><ul>
<li><a class="reference internal" href="#map-size-planning">Map Size Planning</a></li>
<li><a class="reference internal" href="#high-availability-and-failover">High Availability and Failover</a></li>
<li><a class="reference internal" href="#monitoring-and-alerting">Monitoring and Alerting</a></li>
</ul>
</li>
<li><a class="reference internal" href="#the-future-hardware-offload-and-smart-nics">The Future: Hardware Offload and Smart NICs</a></li>
<li><a class="reference internal" href="#conclusion-embracing-the-kernel-space-revolution">Conclusion: Embracing the Kernel-Space Revolution</a></li>
</ul>
</li>
</ul>

      </div>
    </div>
   
    
  </div>

    </aside>
  </div>
</div><script src="../_static/jquery.js?v=5d32c60e"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
    <script src="../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/scripts/furo.js?v=5fa4622c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script src="../_static/header-nav.js?v=e117ad08"></script>
    
<script>
  const github_url = "https://github.com/ngkore";
</script>
</body>
</html>