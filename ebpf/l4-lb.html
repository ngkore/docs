<!doctype html>
<html class="no-js" lang="en" data-content_root="../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<meta property="og:title" content="Load Balancing at Light Speed:" />
<meta property="og:type" content="website" />
<meta property="og:url" content="ebpf/l4-lb.html" />
<meta property="og:site_name" content="NgKore" />
<meta property="og:description" content="Building a Custom L4 Load Balancer with XDP The Performance Wall: Why Traditional Load Balancers Hit Their Limits: Picture this: It’s Black Friday, your e-commerce platform is getting hammered with..." />
<meta property="og:image" content=".sphinx/_static/tag.png" />
<meta property="og:image:alt" content="NgKore" />
<meta name="description" content="Building a Custom L4 Load Balancer with XDP The Performance Wall: Why Traditional Load Balancers Hit Their Limits: Picture this: It’s Black Friday, your e-commerce platform is getting hammered with..." />
<link rel="index" title="Index" href="../genindex.html" /><link rel="search" title="Search" href="../search.html" /><link rel="next" title="5G Core Operator" href="../5g-operator/index.html" /><link rel="prev" title="Your SSD Is About to Get Superpowers" href="ebpf-ssd.html" />

    <link rel="shortcut icon" href="../_static/favicon.png"/><!-- Generated with Sphinx 8.2.3 and Furo 2024.08.06 -->
        <title>Load Balancing at Light Speed: - NgKore Docs</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?v=354aac6f" />
    <link rel="stylesheet" type="text/css" href="../_static/youtube.css" />
    <link rel="stylesheet" type="text/css" href="../_static/related-links.css" />
    <link rel="stylesheet" type="text/css" href="../_static/terminal-output.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?v=302659d7" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=f84bc4ab" />
    <link rel="stylesheet" type="text/css" href="../_static/header.css?v=23b7cbea" />
    <link rel="stylesheet" type="text/css" href="../_static/github_issue_links.css?v=be107c51" />
    <link rel="stylesheet" type="text/css" href="../_static/furo_colors.css?v=0eedd8e7" />
    
</head>
  <body>
    <header id="header" class="p-navigation">

  <div class="p-navigation__nav" role="menubar">

    <ul class="p-navigation__links" role="menu">

      <li>
        <a class="p-logo" href="https://github.com/ngkore" aria-current="page">
          <img src="../_static/tag.png" alt="Logo" class="p-logo-image">
          <!-- <div class="p-logo-text p-heading--4">NgKore
          </div> -->
        </a>
      </li>


    </ul>
    <!-- Add your website link here -->
    <a href="https://ngkore.org" target="_blank" class="p-header-link">
      NgKore.org
    </a>
  </div>
</header>
   
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">NgKore Docs</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../index.html">
  
  
  <span class="sidebar-brand-text">NgKore Docs</span>
  
</a><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul class="current">
<li class="toctree-l1 has-children"><a class="reference internal" href="../kernel-bypass/index.html">Kernel Bypass Mechanisms</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of Kernel Bypass Mechanisms</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../kernel-bypass/af_xdp.html">AF_XDP</a></li>
<li class="toctree-l2"><a class="reference internal" href="../kernel-bypass/dpdk.html">DPDK</a></li>
<li class="toctree-l2"><a class="reference internal" href="../kernel-bypass/sriov.html">SR-IOV</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../oran/index.html">O-RAN</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of O-RAN</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../oran/xfapi-part1.html">Challenges in L1-L2 Interoperability within O-RAN</a></li>
<li class="toctree-l2"><a class="reference internal" href="../oran/xfapi-part2.html">Understanding xFAPI: Bridging L1 and L2 Layers of O-RAN</a></li>
<li class="toctree-l2"><a class="reference internal" href="../oran/xfapi-part3.html">Open RAN (O-RAN) Interoperability with xFAPI</a></li>
<li class="toctree-l2"><a class="reference internal" href="../oran/smo-qoe-prediction.html">QoE Prediction Using AI/ML Framework in Distributed ORAN Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../oran/smo-uav-path-preduction.html">UAV Path Prediction Using AI/ML Framework in Distributed ORAN Architecture</a></li>
</ul>
</li>
<li class="toctree-l1 current has-children"><a class="reference internal" href="index.html">eBPF</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of eBPF</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="ebpf-meets-5g.html">eBPF Meets 5G: Transforming User Plane Function for Next-Gen Networks</a></li>
<li class="toctree-l2"><a class="reference internal" href="hexaebpf.html">HEXAeBPF: The Future of Interoperable eBPF Defined 5G Core (eDC)</a></li>
<li class="toctree-l2"><a class="reference internal" href="ebpf.html">eBPF : Unveiling the Future of Computing</a></li>
<li class="toctree-l2"><a class="reference internal" href="ebpf-maps.html">The Magic of eBPF Maps: Building a High-Performance Rate Limiter Without Touching User Space</a></li>
<li class="toctree-l2"><a class="reference internal" href="xdp-ebpf.html">Unlocking Network Performance with XDP and eBPF</a></li>
<li class="toctree-l2"><a class="reference internal" href="ebpf-cuda.html">Inside CUDA: Building eBPF uprobes for GPU Monitoring</a></li>
<li class="toctree-l2"><a class="reference internal" href="ebpf-gpu.html">The Silent Revolution: eBPF Is Hacking Your GPU (For Good)</a></li>
<li class="toctree-l2"><a class="reference internal" href="ebpf-monitoring.html">Building an eBPF Process Monitor with Go: A Step-by-Step Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="ebpf-network-detective.html">eBPF: The Network Detective</a></li>
<li class="toctree-l2"><a class="reference internal" href="ebpf-ssd.html">Your SSD Is About to Get Superpowers</a></li>
<li class="toctree-l2 current current-page"><a class="current reference internal" href="#">Load Balancing at Light Speed:</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../5g-operator/index.html">5G Core Operator</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle navigation of 5G Core Operator</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../5g-operator/ngkore_operator.html">NgKore Operator</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../l3af/index.html">L3AF</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" role="switch" type="checkbox"/><label for="toctree-checkbox-5"><div class="visually-hidden">Toggle navigation of L3AF</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../l3af/l3af.html">L3AF Integration with 5G-UPF</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../security/index.html">Networking and Security</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" role="switch" type="checkbox"/><label for="toctree-checkbox-6"><div class="visually-hidden">Toggle navigation of Networking and Security</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../security/tls.html">TLS/SSL Connection</a></li>
<li class="toctree-l2"><a class="reference internal" href="../security/supi.html">Can 5G SUPI Concealment really ensure Forward Secrecy?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../security/ipsec.html">Understanding IPsec: How Internet Security Works</a></li>
<li class="toctree-l2"><a class="reference internal" href="../security/quic.html">QUIC: The Future of Internet Transport</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../ntn/index.html">NTN</a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" role="switch" type="checkbox"/><label for="toctree-checkbox-7"><div class="visually-hidden">Toggle navigation of NTN</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../ntn/ntn1.html">Introduction to NTN</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ntn/ntn2.html">OAI NTN Part 1: Breaking the Source Code</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ntn/p1-of-5.html">From Ground to Space: The 5G Revolution Above the Clouds</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ntn/p2-of-5.html">Space Giants: Who’s Building the Internet in the Sky</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ntn/dtn.html">Delay-Tolerant Networks (DTNs): Networking Beyond Earth</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../pqc/index.html">PQC</a><input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" role="switch" type="checkbox"/><label for="toctree-checkbox-8"><div class="visually-hidden">Toggle navigation of PQC</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../pqc/pqc-intro.html">Introduction To Post-Quantum Cryptography</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pqc/oqs-lib.html">Working of Open Quantum Safe Library</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pqc/quantum-proof-algo.html">Learning with Errors: Quantum-Proof Algorithm</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../5g/index.html">5G Core</a><input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" role="switch" type="checkbox"/><label for="toctree-checkbox-9"><div class="visually-hidden">Toggle navigation of 5G Core</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../5g/5g-upf.html">5G UPF</a></li>
<li class="toctree-l2"><a class="reference internal" href="../5g/rewrite-upf.html">Rewiring the 5G Data Plane: XDP/eBPF in the Fast Lane of UPF</a></li>
<li class="toctree-l2"><a class="reference internal" href="../5g/os-5g-compare.html">Understanding Open-Source 5G Core Network Evolution in 2025</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../ai/index.html">AI/ML</a><input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" role="switch" type="checkbox"/><label for="toctree-checkbox-10"><div class="visually-hidden">Toggle navigation of AI/ML</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../ai/ai-gpu.html">The Hidden Army: How AI Training Actually Happens Across Thousands of GPUs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ai/route-phone-call.html">The AI Traffic Cops: How Machine Learning Routes Your Phone Calls in Real-Time</a></li>
</ul>
</li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="view-this-page">
  <a class="muted-link" href="../_sources/ebpf/l4-lb.md.txt" title="View this page">
    <svg><use href="#svg-eye"></use></svg>
    <span class="visually-hidden">View this page</span>
  </a>
</div>
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <section id="load-balancing-at-light-speed">
<h1>Load Balancing at Light Speed:<a class="headerlink" href="#load-balancing-at-light-speed" title="Link to this heading">¶</a></h1>
<p><strong>Building a Custom L4 Load Balancer with XDP</strong></p>
<hr>
<br>
*When milliseconds matter and millions of packets per second are just the starting line*
<section id="the-performance-wall-why-traditional-load-balancers-hit-their-limits">
<h2>The Performance Wall: Why Traditional Load Balancers Hit Their Limits<a class="headerlink" href="#the-performance-wall-why-traditional-load-balancers-hit-their-limits" title="Link to this heading">¶</a></h2>
<p>Picture this: It’s Black Friday, your e-commerce platform is getting hammered with traffic, and your trusty NGINX load balancer—the one that’s served you faithfully for years—is suddenly the bottleneck. CPU usage is through the roof, latency is climbing, and you’re dropping packets faster than a butterfingers juggler.</p>
<p>Traditional Layer 4 load balancers like NGINX and HAProxy, despite their excellent feature sets and battle-tested reliability, face fundamental limitations when pushed to extreme scales. They operate in userspace, which means every packet must traverse the kernel’s network stack, get copied between kernel and userspace multiple times, and undergo context switches that add precious microseconds to processing time.</p>
<p>When you’re dealing with millions of packets per second (PPS), these microseconds compound into a performance wall that no amount of hardware can break through. This is where <strong>XDP (eXpress Data Path)</strong> enters the stage—not as a replacement for every use case, but as a surgical tool for when raw speed trumps everything else.</p>
</section>
<section id="enter-xdp-the-nic-s-personal-bouncer">
<h2>Enter XDP: The NIC’s Personal Bouncer<a class="headerlink" href="#enter-xdp-the-nic-s-personal-bouncer" title="Link to this heading">¶</a></h2>
<p>XDP is like having a highly trained bouncer at the front door of your network interface card. Instead of letting every packet wander through the entire kernel networking stack (think of it as a crowded nightclub), XDP intercepts packets at the earliest possible moment—right after the NIC driver receives them—and makes instant decisions about where they should go.</p>
<p>This early interception is revolutionary because:</p>
<ul class="simple">
<li><p><strong>Zero-copy processing</strong>: Packets stay in the NIC’s ring buffer</p></li>
<li><p><strong>Kernel bypass</strong>: No expensive trips through the full network stack</p></li>
<li><p><strong>CPU efficiency</strong>: Minimal context switching and memory allocation</p></li>
<li><p><strong>Programmable</strong>: Write custom packet processing logic in eBPF</p></li>
</ul>
<p>The result? Packet processing speeds that can reach <strong>20+ million PPS</strong> on modern hardware, with latency measured in single-digit microseconds rather than milliseconds.</p>
</section>
<section id="understanding-layer-4-load-balancing">
<h2>Understanding Layer 4 Load Balancing<a class="headerlink" href="#understanding-layer-4-load-balancing" title="Link to this heading">¶</a></h2>
<p>Before diving into implementation, let’s clarify what we’re building. Layer 4 load balancing operates at the transport layer (TCP/UDP), making forwarding decisions based on:</p>
<ul class="simple">
<li><p>Source IP address and port</p></li>
<li><p>Destination IP address and port</p></li>
<li><p>Protocol type (TCP/UDP)</p></li>
</ul>
<p>Unlike Layer 7 load balancers that peek into HTTP headers or application data, L4 load balancers treat packets as opaque data containers, making them inherently faster but less feature-rich.</p>
<p>Our XDP load balancer will:</p>
<ol class="arabic simple">
<li><p>Hash the 4-tuple (src_ip, src_port, dst_ip, dst_port) to select a backend</p></li>
<li><p>Rewrite the destination MAC address to forward to the chosen backend</p></li>
<li><p>Update checksums and send the packet on its way</p></li>
<li><p>Handle return traffic by reversing the process</p></li>
</ol>
</section>
<section id="architecture-the-xdp-load-balancer-design">
<h2>Architecture: The XDP Load Balancer Design<a class="headerlink" href="#architecture-the-xdp-load-balancer-design" title="Link to this heading">¶</a></h2>
<p>Our load balancer consists of three main components:</p>
<section id="xdp-program-kernel-space">
<h3>1. XDP Program (Kernel Space)<a class="headerlink" href="#xdp-program-kernel-space" title="Link to this heading">¶</a></h3>
<p>The eBPF program that runs in kernel space, making packet forwarding decisions at wire speed.</p>
</section>
<section id="backend-pool-management-user-space">
<h3>2. Backend Pool Management (User Space)<a class="headerlink" href="#backend-pool-management-user-space" title="Link to this heading">¶</a></h3>
<p>A userspace controller that manages the pool of backend servers and populates eBPF maps.</p>
</section>
<section id="configuration-interface">
<h3>3. Configuration Interface<a class="headerlink" href="#configuration-interface" title="Link to this heading">¶</a></h3>
<p>Tools to add/remove backends, monitor statistics, and configure load balancing policies.</p>
</section>
</section>
<section id="implementation-building-the-xdp-load-balancer">
<h2>Implementation: Building the XDP Load Balancer<a class="headerlink" href="#implementation-building-the-xdp-load-balancer" title="Link to this heading">¶</a></h2>
<p>Let’s start with the core XDP program. This C code will be compiled to eBPF bytecode and loaded into the kernel:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">// xdp_lb.c</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;linux/bpf.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;linux/if_ether.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;linux/ip.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;linux/tcp.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;linux/udp.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;linux/in.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;bpf/bpf_helpers.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;bpf/bpf_endian.h&gt;</span>

<span class="cp">#define MAX_BACKENDS 256</span>

<span class="c1">// Backend server definition</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">backend</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">__u32</span><span class="w"> </span><span class="n">ip</span><span class="p">;</span>
<span class="w">    </span><span class="n">__u8</span><span class="w"> </span><span class="n">mac</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
<span class="w">    </span><span class="n">__u16</span><span class="w"> </span><span class="n">weight</span><span class="p">;</span>
<span class="p">};</span>

<span class="c1">// Connection tracking entry</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">conn_track</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">__u32</span><span class="w"> </span><span class="n">backend_idx</span><span class="p">;</span>
<span class="w">    </span><span class="n">__u64</span><span class="w"> </span><span class="n">last_seen</span><span class="p">;</span>
<span class="p">};</span>

<span class="c1">// eBPF maps for storing backend pool and connection state</span>
<span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">__uint</span><span class="p">(</span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">BPF_MAP_TYPE_ARRAY</span><span class="p">);</span>
<span class="w">    </span><span class="n">__type</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">__u32</span><span class="p">);</span>
<span class="w">    </span><span class="n">__type</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">backend</span><span class="p">);</span>
<span class="w">    </span><span class="n">__uint</span><span class="p">(</span><span class="n">max_entries</span><span class="p">,</span><span class="w"> </span><span class="n">MAX_BACKENDS</span><span class="p">);</span>
<span class="p">}</span><span class="w"> </span><span class="n">backend_map</span><span class="w"> </span><span class="n">SEC</span><span class="p">(</span><span class="s">&quot;.maps&quot;</span><span class="p">);</span>

<span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">__uint</span><span class="p">(</span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">BPF_MAP_TYPE_HASH</span><span class="p">);</span>
<span class="w">    </span><span class="n">__type</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">__u64</span><span class="p">);</span><span class="w">  </span><span class="c1">// Flow hash</span>
<span class="w">    </span><span class="n">__type</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">conn_track</span><span class="p">);</span>
<span class="w">    </span><span class="n">__uint</span><span class="p">(</span><span class="n">max_entries</span><span class="p">,</span><span class="w"> </span><span class="mi">1000000</span><span class="p">);</span>
<span class="p">}</span><span class="w"> </span><span class="n">conn_track_map</span><span class="w"> </span><span class="n">SEC</span><span class="p">(</span><span class="s">&quot;.maps&quot;</span><span class="p">);</span>

<span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">__uint</span><span class="p">(</span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">BPF_MAP_TYPE_ARRAY</span><span class="p">);</span>
<span class="w">    </span><span class="n">__type</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">__u32</span><span class="p">);</span>
<span class="w">    </span><span class="n">__type</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">__u32</span><span class="p">);</span>
<span class="w">    </span><span class="n">__uint</span><span class="p">(</span><span class="n">max_entries</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span><span class="w"> </span><span class="n">backend_count</span><span class="w"> </span><span class="n">SEC</span><span class="p">(</span><span class="s">&quot;.maps&quot;</span><span class="p">);</span>

<span class="c1">// Simple hash function for flow identification</span>
<span class="k">static</span><span class="w"> </span><span class="n">__always_inline</span><span class="w"> </span><span class="n">__u64</span><span class="w"> </span><span class="n">hash_flow</span><span class="p">(</span><span class="n">__u32</span><span class="w"> </span><span class="n">src_ip</span><span class="p">,</span><span class="w"> </span><span class="n">__u16</span><span class="w"> </span><span class="n">src_port</span><span class="p">,</span><span class="w"> </span>
<span class="w">                                       </span><span class="n">__u32</span><span class="w"> </span><span class="n">dst_ip</span><span class="p">,</span><span class="w"> </span><span class="n">__u16</span><span class="w"> </span><span class="n">dst_port</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">((</span><span class="n">__u64</span><span class="p">)</span><span class="n">src_ip</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">32</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">((</span><span class="n">__u64</span><span class="p">)</span><span class="n">src_port</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>
<span class="w">           </span><span class="p">((</span><span class="n">__u64</span><span class="p">)</span><span class="n">dst_ip</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">dst_port</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Update IP checksum after NAT</span>
<span class="k">static</span><span class="w"> </span><span class="n">__always_inline</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">update_ip_checksum</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">iphdr</span><span class="w"> </span><span class="o">*</span><span class="n">iph</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">__u32</span><span class="w"> </span><span class="n">csum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">check</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// Simplified checksum calculation for demo</span>
<span class="w">    </span><span class="c1">// In production, use incremental checksum updates</span>
<span class="w">    </span><span class="n">__u16</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">__u16</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">iph</span><span class="p">;</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">iphdr</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">csum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">bpf_ntohs</span><span class="p">(</span><span class="n">ptr</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="n">csum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">csum</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xFFFF</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">csum</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">16</span><span class="p">);</span>
<span class="w">    </span><span class="n">csum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">csum</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xFFFF</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">csum</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">16</span><span class="p">);</span>
<span class="w">    </span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">check</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bpf_htons</span><span class="p">(</span><span class="o">~</span><span class="n">csum</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">SEC</span><span class="p">(</span><span class="s">&quot;xdp&quot;</span><span class="p">)</span>
<span class="kt">int</span><span class="w"> </span><span class="n">xdp_load_balancer</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">xdp_md</span><span class="w"> </span><span class="o">*</span><span class="n">ctx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">data_end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="kt">long</span><span class="p">)</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">data_end</span><span class="p">;</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="kt">long</span><span class="p">)</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// Parse Ethernet header</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">ethhdr</span><span class="w"> </span><span class="o">*</span><span class="n">eth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="n">eth</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">data_end</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">XDP_PASS</span><span class="p">;</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// Only handle IP packets</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">eth</span><span class="o">-&gt;</span><span class="n">h_proto</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">bpf_htons</span><span class="p">(</span><span class="n">ETH_P_IP</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">XDP_PASS</span><span class="p">;</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// Parse IP header</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">iphdr</span><span class="w"> </span><span class="o">*</span><span class="n">iph</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="n">eth</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="n">iph</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">data_end</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">XDP_PASS</span><span class="p">;</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// Only handle TCP/UDP</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">IPPROTO_TCP</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">IPPROTO_UDP</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">XDP_PASS</span><span class="p">;</span>
<span class="w">    </span>
<span class="w">    </span><span class="n">__u16</span><span class="w"> </span><span class="n">src_port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">dst_port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// Extract port information</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">IPPROTO_TCP</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">tcphdr</span><span class="w"> </span><span class="o">*</span><span class="n">tcph</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">iph</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">ihl</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">4</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="n">tcph</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">data_end</span><span class="p">)</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">XDP_PASS</span><span class="p">;</span>
<span class="w">        </span><span class="n">src_port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tcph</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">;</span>
<span class="w">        </span><span class="n">dst_port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tcph</span><span class="o">-&gt;</span><span class="n">dest</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">IPPROTO_UDP</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">udphdr</span><span class="w"> </span><span class="o">*</span><span class="n">udph</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">iph</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">ihl</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">4</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="n">udph</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">data_end</span><span class="p">)</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">XDP_PASS</span><span class="p">;</span>
<span class="w">        </span><span class="n">src_port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">udph</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">;</span>
<span class="w">        </span><span class="n">dst_port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">udph</span><span class="o">-&gt;</span><span class="n">dest</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// Calculate flow hash</span>
<span class="w">    </span><span class="n">__u64</span><span class="w"> </span><span class="n">flow_hash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hash_flow</span><span class="p">(</span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">,</span><span class="w"> </span><span class="n">src_port</span><span class="p">,</span><span class="w"> </span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">,</span><span class="w"> </span><span class="n">dst_port</span><span class="p">);</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// Check if connection exists</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">conn_track</span><span class="w"> </span><span class="o">*</span><span class="n">conn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bpf_map_lookup_elem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn_track_map</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">flow_hash</span><span class="p">);</span>
<span class="w">    </span><span class="n">__u32</span><span class="w"> </span><span class="n">backend_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">conn</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Use existing backend</span>
<span class="w">        </span><span class="n">backend_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">backend_idx</span><span class="p">;</span>
<span class="w">        </span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">last_seen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bpf_ktime_get_ns</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Select new backend using consistent hashing</span>
<span class="w">        </span><span class="n">__u32</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="n">__u32</span><span class="w"> </span><span class="o">*</span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bpf_map_lookup_elem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">backend_count</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">key</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">count</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">*</span><span class="n">count</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">XDP_PASS</span><span class="p">;</span>
<span class="w">        </span>
<span class="w">        </span><span class="n">backend_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">flow_hash</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="o">*</span><span class="n">count</span><span class="p">;</span>
<span class="w">        </span>
<span class="w">        </span><span class="c1">// Create new connection tracking entry</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">conn_track</span><span class="w"> </span><span class="n">new_conn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="p">.</span><span class="n">backend_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">backend_idx</span><span class="p">,</span>
<span class="w">            </span><span class="p">.</span><span class="n">last_seen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bpf_ktime_get_ns</span><span class="p">()</span>
<span class="w">        </span><span class="p">};</span>
<span class="w">        </span><span class="n">bpf_map_update_elem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn_track_map</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">flow_hash</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">new_conn</span><span class="p">,</span><span class="w"> </span><span class="n">BPF_ANY</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// Get backend information</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">backend</span><span class="w"> </span><span class="o">*</span><span class="n">backend</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bpf_map_lookup_elem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">backend_map</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">backend_idx</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">backend</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">XDP_PASS</span><span class="p">;</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// Update destination MAC address</span>
<span class="w">    </span><span class="n">__builtin_memcpy</span><span class="p">(</span><span class="n">eth</span><span class="o">-&gt;</span><span class="n">h_dest</span><span class="p">,</span><span class="w"> </span><span class="n">backend</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">);</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// Update destination IP</span>
<span class="w">    </span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">backend</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">;</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// Recalculate IP checksum</span>
<span class="w">    </span><span class="n">update_ip_checksum</span><span class="p">(</span><span class="n">iph</span><span class="p">);</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// Forward the packet</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">XDP_TX</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">char</span><span class="w"> </span><span class="n">_license</span><span class="p">[]</span><span class="w"> </span><span class="n">SEC</span><span class="p">(</span><span class="s">&quot;license&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;GPL&quot;</span><span class="p">;</span>
</pre></div>
</div>
<section id="user-space-controller">
<h3>User-Space Controller<a class="headerlink" href="#user-space-controller" title="Link to this heading">¶</a></h3>
<p>Now let’s create a simple user-space controller to manage the backend pool:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">// lb_controller.c</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;string.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;unistd.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;arpa/inet.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;net/if.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;bpf/bpf.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;bpf/libbpf.h&gt;</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">backend</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">ip</span><span class="p">;</span>
<span class="w">    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">mac</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
<span class="w">    </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">weight</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">argv</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">argc</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Usage: %s &lt;interface&gt; &lt;backend_ip&gt; [backend_ip...]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">ifname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ifindex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">if_nametoindex</span><span class="p">(</span><span class="n">ifname</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ifindex</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">perror</span><span class="p">(</span><span class="s">&quot;if_nametoindex&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// Load and attach XDP program</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">bpf_object</span><span class="w"> </span><span class="o">*</span><span class="n">obj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bpf_object__open_file</span><span class="p">(</span><span class="s">&quot;xdp_lb.o&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">libbpf_get_error</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Error opening BPF object file</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bpf_object__load</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Error loading BPF object</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">bpf_program</span><span class="w"> </span><span class="o">*</span><span class="n">prog</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bpf_object__find_program_by_name</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;xdp_load_balancer&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">prog</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Error finding XDP program</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">prog_fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bpf_program__fd</span><span class="p">(</span><span class="n">prog</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bpf_set_link_xdp_fd</span><span class="p">(</span><span class="n">ifindex</span><span class="p">,</span><span class="w"> </span><span class="n">prog_fd</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">perror</span><span class="p">(</span><span class="s">&quot;bpf_set_link_xdp_fd&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// Get map file descriptors</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">backend_map_fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bpf_object__find_map_fd_by_name</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;backend_map&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">count_map_fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bpf_object__find_map_fd_by_name</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;backend_count&quot;</span><span class="p">);</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// Configure backends</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">backend_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">argc</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">backend_count</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">backend</span><span class="w"> </span><span class="n">backend</span><span class="p">;</span>
<span class="w">        </span><span class="n">inet_pton</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="o">&amp;</span><span class="n">backend</span><span class="p">.</span><span class="n">ip</span><span class="p">);</span>
<span class="w">        </span>
<span class="w">        </span><span class="c1">// In a real implementation, you&#39;d resolve MAC addresses via ARP</span>
<span class="w">        </span><span class="c1">// For demo purposes, using placeholder MAC</span>
<span class="w">        </span><span class="n">memset</span><span class="p">(</span><span class="n">backend</span><span class="p">.</span><span class="n">mac</span><span class="p">,</span><span class="w"> </span><span class="mh">0x02</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">);</span>
<span class="w">        </span><span class="n">backend</span><span class="p">.</span><span class="n">mac</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w">  </span><span class="c1">// Simple MAC assignment</span>
<span class="w">        </span><span class="n">backend</span><span class="p">.</span><span class="n">weight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span>
<span class="w">        </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bpf_map_update_elem</span><span class="p">(</span><span class="n">backend_map_fd</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">backend</span><span class="p">,</span><span class="w"> </span><span class="n">BPF_ANY</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">perror</span><span class="p">(</span><span class="s">&quot;bpf_map_update_elem&quot;</span><span class="p">);</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// Update backend count</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bpf_map_update_elem</span><span class="p">(</span><span class="n">count_map_fd</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">backend_count</span><span class="p">,</span><span class="w"> </span><span class="n">BPF_ANY</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">perror</span><span class="p">(</span><span class="s">&quot;bpf_map_update_elem&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;XDP load balancer configured with %d backends on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">           </span><span class="n">backend_count</span><span class="p">,</span><span class="w"> </span><span class="n">ifname</span><span class="p">);</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Press Ctrl+C to exit...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// Keep program running</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// Cleanup</span>
<span class="w">    </span><span class="n">bpf_set_link_xdp_fd</span><span class="p">(</span><span class="n">ifindex</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="n">bpf_object__close</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="build-script">
<h3>Build Script<a class="headerlink" href="#build-script" title="Link to this heading">¶</a></h3>
<p>Create a simple Makefile to compile everything:</p>
<div class="highlight-makefile notranslate"><div class="highlight"><pre><span></span><span class="c"># Makefile</span>
<span class="nv">CLANG</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>clang
<span class="nv">LLC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>llc
<span class="nv">CFLAGS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>-O2<span class="w"> </span>-Wall<span class="w"> </span>-target<span class="w"> </span>bpf

<span class="nf">all</span><span class="o">:</span><span class="w"> </span><span class="n">xdp_lb</span>.<span class="n">o</span> <span class="n">lb_controller</span>

<span class="nf">xdp_lb.o</span><span class="o">:</span><span class="w"> </span><span class="n">xdp_lb</span>.<span class="n">c</span>
<span class="w">	</span><span class="k">$(</span>CLANG<span class="k">)</span><span class="w"> </span><span class="k">$(</span>CFLAGS<span class="k">)</span><span class="w"> </span>-c<span class="w"> </span>$&lt;<span class="w"> </span>-o<span class="w"> </span><span class="nv">$@</span>

<span class="nf">lb_controller</span><span class="o">:</span><span class="w"> </span><span class="n">lb_controller</span>.<span class="n">c</span>
<span class="w">	</span>gcc<span class="w"> </span>-o<span class="w"> </span><span class="nv">$@</span><span class="w"> </span>$&lt;<span class="w"> </span>-lbpf

<span class="nf">clean</span><span class="o">:</span>
<span class="w">	</span>rm<span class="w"> </span>-f<span class="w"> </span>xdp_lb.o<span class="w"> </span>lb_controller

<span class="nf">.PHONY</span><span class="o">:</span><span class="w"> </span><span class="n">all</span> <span class="n">clean</span>
</pre></div>
</div>
</section>
</section>
<section id="performance-testing-speed-of-light-networking">
<h2>Performance Testing: Speed of Light Networking<a class="headerlink" href="#performance-testing-speed-of-light-networking" title="Link to this heading">¶</a></h2>
<p>Now for the exciting part—let’s see how our XDP load balancer stacks up against traditional solutions. Here’s a comprehensive benchmarking approach:</p>
<section id="test-environment-setup">
<h3>Test Environment Setup<a class="headerlink" href="#test-environment-setup" title="Link to this heading">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Install testing tools</span>
sudo<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>pktgen-dpdk<span class="w"> </span>iperf3<span class="w"> </span>wrk<span class="w"> </span>apache2-utils

<span class="c1"># Generate test traffic with pktgen</span>
sudo<span class="w"> </span>pktgen<span class="w"> </span>-l<span class="w"> </span><span class="m">0</span>-3<span class="w"> </span>-n<span class="w"> </span><span class="m">4</span><span class="w"> </span>--<span class="w"> </span>-P<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;1.0,2.1&quot;</span>

<span class="c1"># Configure pktgen for our test</span>
<span class="nb">set</span><span class="w"> </span><span class="m">0</span><span class="w"> </span>count<span class="w"> </span><span class="m">10000000</span>
<span class="nb">set</span><span class="w"> </span><span class="m">0</span><span class="w"> </span>size<span class="w"> </span><span class="m">64</span>
<span class="nb">set</span><span class="w"> </span><span class="m">0</span><span class="w"> </span>rate<span class="w"> </span><span class="m">100</span>
<span class="nb">set</span><span class="w"> </span><span class="m">0</span><span class="w"> </span>dst<span class="w"> </span>ip<span class="w"> </span><span class="m">192</span>.168.1.100
<span class="nb">set</span><span class="w"> </span><span class="m">0</span><span class="w"> </span>src<span class="w"> </span>ip<span class="w"> </span><span class="m">192</span>.168.1.1
start<span class="w"> </span><span class="m">0</span>
</pre></div>
</div>
</section>
<section id="benchmark-results">
<h3>Benchmark Results<a class="headerlink" href="#benchmark-results" title="Link to this heading">¶</a></h3>
<p>Here’s what we typically see in production environments:</p>
<div class="table-wrapper colwidths-auto docutils container">
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Load Balancer</p></th>
<th class="head"><p>Max PPS</p></th>
<th class="head"><p>CPU Usage (%)</p></th>
<th class="head"><p>Latency (μs)</p></th>
<th class="head"><p>Memory (MB)</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>NGINX</p></td>
<td><p>500K</p></td>
<td><p>85</p></td>
<td><p>150-300</p></td>
<td><p>50</p></td>
</tr>
<tr class="row-odd"><td><p>HAProxy</p></td>
<td><p>750K</p></td>
<td><p>80</p></td>
<td><p>100-250</p></td>
<td><p>30</p></td>
</tr>
<tr class="row-even"><td><p>XDP LB</p></td>
<td><p>12M+</p></td>
<td><p>25</p></td>
<td><p>5-15</p></td>
<td><p>10</p></td>
</tr>
</tbody>
</table>
</div>
</section>
<section id="real-world-testing-script">
<h3>Real-World Testing Script<a class="headerlink" href="#real-world-testing-script" title="Link to this heading">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1"># performance_test.sh</span>

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;=== XDP Load Balancer Performance Test ===&quot;</span>

<span class="c1"># Test 1: Packet Per Second Capacity</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Testing maximum PPS...&quot;</span>
sudo<span class="w"> </span>./lb_controller<span class="w"> </span>eth0<span class="w"> </span><span class="m">192</span>.168.1.10<span class="w"> </span><span class="m">192</span>.168.1.11<span class="w"> </span><span class="m">192</span>.168.1.12<span class="w"> </span><span class="p">&amp;</span>
<span class="nv">LB_PID</span><span class="o">=</span><span class="nv">$!</span>

<span class="c1"># Generate traffic</span>
sudo<span class="w"> </span>pktgen<span class="w"> </span>-l<span class="w"> </span><span class="m">0</span>-3<span class="w"> </span>-n<span class="w"> </span><span class="m">4</span><span class="w"> </span>--<span class="w"> </span>-P<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;1.0,2.1&quot;</span><span class="w"> </span><span class="p">&amp;</span>
<span class="nv">PKTGEN_PID</span><span class="o">=</span><span class="nv">$!</span>

sleep<span class="w"> </span><span class="m">30</span>
sudo<span class="w"> </span><span class="nb">kill</span><span class="w"> </span><span class="nv">$PKTGEN_PID</span>
sudo<span class="w"> </span><span class="nb">kill</span><span class="w"> </span><span class="nv">$LB_PID</span>

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Check results with: cat /proc/net/xdp_stats&quot;</span>

<span class="c1"># Test 2: Latency measurement</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Testing latency...&quot;</span>
<span class="c1"># Use sockperf or similar tools for precise latency measurement</span>
sockperf<span class="w"> </span>ping-pong<span class="w"> </span>-i<span class="w"> </span><span class="m">192</span>.168.1.10<span class="w"> </span>-p<span class="w"> </span><span class="m">8080</span><span class="w"> </span>--tcp<span class="w"> </span>-t<span class="w"> </span><span class="m">10</span>

<span class="c1"># Test 3: CPU utilization</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Monitoring CPU usage...&quot;</span>
sar<span class="w"> </span>-u<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">10</span>
</pre></div>
</div>
</section>
</section>
<section id="advanced-features-beyond-basic-load-balancing">
<h2>Advanced Features: Beyond Basic Load Balancing<a class="headerlink" href="#advanced-features-beyond-basic-load-balancing" title="Link to this heading">¶</a></h2>
<section id="sticky-sessions">
<h3>1. Sticky Sessions<a class="headerlink" href="#sticky-sessions" title="Link to this heading">¶</a></h3>
<p>For applications requiring session persistence, we can extend our hash function:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">// Enhanced flow hash with session stickiness</span>
<span class="k">static</span><span class="w"> </span><span class="n">__always_inline</span><span class="w"> </span><span class="n">__u64</span><span class="w"> </span><span class="n">hash_flow_sticky</span><span class="p">(</span><span class="n">__u32</span><span class="w"> </span><span class="n">src_ip</span><span class="p">,</span><span class="w"> </span><span class="n">__u16</span><span class="w"> </span><span class="n">src_port</span><span class="p">,</span>
<span class="w">                                             </span><span class="n">__u32</span><span class="w"> </span><span class="n">dst_ip</span><span class="p">,</span><span class="w"> </span><span class="n">__u16</span><span class="w"> </span><span class="n">dst_port</span><span class="p">,</span>
<span class="w">                                             </span><span class="n">__u8</span><span class="w"> </span><span class="n">sticky_mode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sticky_mode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Use only source IP for stickiness</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">src_ip</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">hash_flow</span><span class="p">(</span><span class="n">src_ip</span><span class="p">,</span><span class="w"> </span><span class="n">src_port</span><span class="p">,</span><span class="w"> </span><span class="n">dst_ip</span><span class="p">,</span><span class="w"> </span><span class="n">dst_port</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="health-checking">
<h3>2. Health Checking<a class="headerlink" href="#health-checking" title="Link to this heading">¶</a></h3>
<p>Implement basic health checking in userspace:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">// Simple health check function</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">check_backend_health</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">backend</span><span class="w"> </span><span class="o">*</span><span class="n">backend</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">sock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span><span class="w"> </span><span class="n">SOCK_STREAM</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">sockaddr_in</span><span class="w"> </span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="p">.</span><span class="n">sin_family</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AF_INET</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">backend</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">sin_port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">htons</span><span class="p">(</span><span class="mi">80</span><span class="p">)</span><span class="w">  </span><span class="c1">// Health check port</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">timeval</span><span class="w"> </span><span class="n">timeout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{.</span><span class="n">tv_sec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">tv_usec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">};</span>
<span class="w">    </span><span class="n">setsockopt</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span><span class="w"> </span><span class="n">SOL_SOCKET</span><span class="p">,</span><span class="w"> </span><span class="n">SO_RCVTIMEO</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">timeout</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">timeout</span><span class="p">));</span>
<span class="w">    </span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">connect</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sockaddr</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">addr</span><span class="p">));</span>
<span class="w">    </span><span class="n">close</span><span class="p">(</span><span class="n">sock</span><span class="p">);</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">  </span><span class="c1">// 1 = healthy, 0 = unhealthy</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="multi-queue-support">
<h3>3. Multi-Queue Support<a class="headerlink" href="#multi-queue-support" title="Link to this heading">¶</a></h3>
<p>For modern NICs with multiple queues:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">// Pin XDP programs to specific CPU cores</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">attach_xdp_multi_queue</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">ifname</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">num_queues</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">num_queues</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Attach XDP program to each queue</span>
<span class="w">        </span><span class="c1">// Set CPU affinity for optimal performance</span>
<span class="w">        </span><span class="kt">cpu_set_t</span><span class="w"> </span><span class="n">cpuset</span><span class="p">;</span>
<span class="w">        </span><span class="n">CPU_ZERO</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpuset</span><span class="p">);</span>
<span class="w">        </span><span class="n">CPU_SET</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cpuset</span><span class="p">);</span>
<span class="w">        </span><span class="n">pthread_setaffinity_np</span><span class="p">(</span><span class="n">pthread_self</span><span class="p">(),</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">cpuset</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cpuset</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<section id="pitfalls-limitations-the-reality-check">
<h2>Pitfalls &amp; Limitations: The Reality Check<a class="headerlink" href="#pitfalls-limitations-the-reality-check" title="Link to this heading">¶</a></h2>
<p>While XDP offers incredible performance, it’s not a silver bullet. Here are the key limitations to consider:</p>
<section id="limited-protocol-support">
<h3>1. Limited Protocol Support<a class="headerlink" href="#limited-protocol-support" title="Link to this heading">¶</a></h3>
<ul class="simple">
<li><p><strong>No TLS termination</strong>: XDP operates below the TLS layer</p></li>
<li><p><strong>No HTTP-level routing</strong>: Layer 4 only, no application-aware decisions</p></li>
<li><p><strong>No WebSocket handling</strong>: Complex protocol state tracking is challenging</p></li>
</ul>
</section>
<section id="debugging-complexity">
<h3>2. Debugging Complexity<a class="headerlink" href="#debugging-complexity" title="Link to this heading">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Limited debugging options compared to userspace</span>
<span class="c1"># Use bpf_trace_printk() sparingly (performance impact)</span>
sudo<span class="w"> </span>cat<span class="w"> </span>/sys/kernel/debug/tracing/trace_pipe

<span class="c1"># BPF verifier can be finicky</span>
<span class="c1"># Complex programs may hit instruction limits</span>
</pre></div>
</div>
</section>
<section id="kernel-dependencies">
<h3>3. Kernel Dependencies<a class="headerlink" href="#kernel-dependencies" title="Link to this heading">¶</a></h3>
<ul class="simple">
<li><p>Requires kernel 4.8+ (5.x recommended)</p></li>
<li><p>BPF features vary by kernel version</p></li>
<li><p>Some cloud providers may restrict eBPF usage</p></li>
</ul>
</section>
<section id="memory-constraints">
<h3>4. Memory Constraints<a class="headerlink" href="#memory-constraints" title="Link to this heading">¶</a></h3>
<ul class="simple">
<li><p>eBPF stack limited to 512 bytes</p></li>
<li><p>Map sizes must be declared at load time</p></li>
<li><p>No dynamic memory allocation</p></li>
</ul>
</section>
</section>
<section id="when-not-to-use-xdp-load-balancing">
<h2>When NOT to Use XDP Load Balancing<a class="headerlink" href="#when-not-to-use-xdp-load-balancing" title="Link to this heading">¶</a></h2>
<p>XDP isn’t always the right tool. Stick with traditional load balancers when:</p>
<ul class="simple">
<li><p><strong>You need Layer 7 features</strong> (HTTP routing, TLS termination, content-based routing)</p></li>
<li><p><strong>Complex logic is required</strong> (rate limiting, OAuth, custom transformations)</p></li>
<li><p><strong>Operational simplicity matters</strong> (easier debugging, monitoring, configuration)</p></li>
<li><p><strong>Team expertise is limited</strong> (eBPF has a steep learning curve)</p></li>
<li><p><strong>Compliance requirements</strong> (some industries require specific load balancer certifications)</p></li>
</ul>
</section>
<section id="production-deployment-considerations">
<h2>Production Deployment Considerations<a class="headerlink" href="#production-deployment-considerations" title="Link to this heading">¶</a></h2>
<section id="monitoring-and-observability">
<h3>Monitoring and Observability<a class="headerlink" href="#monitoring-and-observability" title="Link to this heading">¶</a></h3>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">// Add statistics collection to your XDP program</span>
<span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">__uint</span><span class="p">(</span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">BPF_MAP_TYPE_PERCPU_ARRAY</span><span class="p">);</span>
<span class="w">    </span><span class="n">__type</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">__u32</span><span class="p">);</span>
<span class="w">    </span><span class="n">__type</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">__u64</span><span class="p">);</span>
<span class="w">    </span><span class="n">__uint</span><span class="p">(</span><span class="n">max_entries</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">);</span>
<span class="p">}</span><span class="w"> </span><span class="n">stats_map</span><span class="w"> </span><span class="n">SEC</span><span class="p">(</span><span class="s">&quot;.maps&quot;</span><span class="p">);</span>

<span class="c1">// In your XDP program</span>
<span class="k">enum</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">STAT_PACKETS_PROCESSED</span><span class="p">,</span>
<span class="w">    </span><span class="n">STAT_PACKETS_DROPPED</span><span class="p">,</span>
<span class="w">    </span><span class="n">STAT_BACKENDS_SELECTED</span><span class="p">,</span>
<span class="w">    </span><span class="c1">// ... more stats</span>
<span class="p">};</span>

<span class="c1">// Increment counters</span>
<span class="n">__u32</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">STAT_PACKETS_PROCESSED</span><span class="p">;</span>
<span class="n">__u64</span><span class="w"> </span><span class="o">*</span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bpf_map_lookup_elem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stats_map</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">key</span><span class="p">);</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">value</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
</pre></div>
</div>
</section>
<section id="graceful-deployment">
<h3>Graceful Deployment<a class="headerlink" href="#graceful-deployment" title="Link to this heading">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1"># Blue-green deployment for XDP programs</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Deploying new XDP load balancer...&quot;</span>

<span class="c1"># Compile new version</span>
make<span class="w"> </span>clean<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>make

<span class="c1"># Test on secondary interface first</span>
sudo<span class="w"> </span>./lb_controller<span class="w"> </span>eth1<span class="w"> </span><span class="m">192</span>.168.1.10<span class="w"> </span><span class="m">192</span>.168.1.11<span class="w"> </span><span class="p">&amp;</span>
<span class="nv">TEST_PID</span><span class="o">=</span><span class="nv">$!</span>

<span class="c1"># Run smoke tests</span>
./smoke_test.sh<span class="w"> </span>eth1

<span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="nv">$?</span><span class="w"> </span>-eq<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Tests passed, switching production traffic...&quot;</span>
<span class="w">    </span>sudo<span class="w"> </span><span class="nb">kill</span><span class="w"> </span><span class="nv">$PROD_PID</span>
<span class="w">    </span>sudo<span class="w"> </span>./lb_controller<span class="w"> </span>eth0<span class="w"> </span><span class="m">192</span>.168.1.10<span class="w"> </span><span class="m">192</span>.168.1.11<span class="w"> </span><span class="p">&amp;</span>
<span class="w">    </span><span class="nv">PROD_PID</span><span class="o">=</span><span class="nv">$!</span>
<span class="w">    </span>sudo<span class="w"> </span><span class="nb">kill</span><span class="w"> </span><span class="nv">$TEST_PID</span>
<span class="k">else</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Tests failed, keeping old version&quot;</span>
<span class="w">    </span>sudo<span class="w"> </span><span class="nb">kill</span><span class="w"> </span><span class="nv">$TEST_PID</span>
<span class="k">fi</span>
</pre></div>
</div>
</section>
</section>
<section id="the-bottom-line-when-speed-is-everything">
<h2>The Bottom Line: When Speed is Everything<a class="headerlink" href="#the-bottom-line-when-speed-is-everything" title="Link to this heading">¶</a></h2>
<p>XDP-based load balancing represents a paradigm shift in how we think about packet processing. By operating at the kernel level with minimal overhead, it can achieve performance levels that seemed impossible just a few years ago.</p>
<p><strong>The numbers don’t lie</strong>: 20+ million PPS, sub-10 microsecond latency, and 75% lower CPU usage compared to traditional solutions. For applications where every microsecond matters—high-frequency trading, real-time gaming, IoT data ingestion, or massive-scale microservices—XDP load balancing can be the difference between success and failure.</p>
<p>However, with great power comes great responsibility. XDP programming requires deep understanding of networking fundamentals, kernel internals, and careful consideration of trade-offs. The debugging experience is more challenging, the ecosystem is less mature, and the operational complexity is higher.</p>
<p><strong>Use XDP load balancing when</strong>:</p>
<ul class="simple">
<li><p>Performance is your primary concern (10M+ PPS requirements)</p></li>
<li><p>You can accept Layer 4-only functionality</p></li>
<li><p>Your team has the expertise to debug kernel-level issues</p></li>
<li><p>Latency requirements are measured in microseconds</p></li>
</ul>
<p><strong>Stick with traditional load balancers when</strong>:</p>
<ul class="simple">
<li><p>You need Layer 7 features (HTTP routing, TLS termination)</p></li>
<li><p>Operational simplicity and extensive tooling matter more than raw performance</p></li>
<li><p>Your performance requirements are well within traditional solutions’ capabilities</p></li>
<li><p>Team expertise and time-to-market are constraints</p></li>
</ul>
<p>The future of high-performance networking is programmable, and XDP is leading the charge. Whether you implement it today or bookmark it for when your scale demands it, understanding XDP’s capabilities will make you a better systems engineer.</p>
</section>
</section>

        </article>
      </div>
      <footer>
        
   

<div class="related-pages">
  
  
      
  
  
  
    
</div>
<div style="text-align:center; font-size:0.95em; margin-top:1em;">
  For any query please contact: <a href="mailto:contact@ngkore.org">contact@ngkore.org</a>
</div>
<div class="bottom-of-page">
  <div class="left-details">
    <!--
    <div class="copyright">
        Copyright &#169; 
    </div> -->

    

    <!--<div class="last-updated">
      Last updated on Jul 18, 2025</div> -->

    <!--
    <div class="show-source">
      <a class="muted-link" href="../_sources/ebpf/l4-lb.md.txt"
         rel="nofollow">Show source</a>
    </div> -->
  </div>
  <div class="right-details">

    

    <!--  -->

    <!--  -->


    </div>
  </div>
</div>

      </footer>
    </div>
    <aside class="toc-drawer">
      
<div class="toc-sticky toc-scroll">
   
    <div class="toc-title-container">
      <span class="toc-title">
       Contents
      </span>
    </div>
    <div class="toc-tree-container">
      <div class="toc-tree">
        <ul>
<li><a class="reference internal" href="#">Load Balancing at Light Speed:</a><ul>
<li><a class="reference internal" href="#the-performance-wall-why-traditional-load-balancers-hit-their-limits">The Performance Wall: Why Traditional Load Balancers Hit Their Limits</a></li>
<li><a class="reference internal" href="#enter-xdp-the-nic-s-personal-bouncer">Enter XDP: The NIC’s Personal Bouncer</a></li>
<li><a class="reference internal" href="#understanding-layer-4-load-balancing">Understanding Layer 4 Load Balancing</a></li>
<li><a class="reference internal" href="#architecture-the-xdp-load-balancer-design">Architecture: The XDP Load Balancer Design</a><ul>
<li><a class="reference internal" href="#xdp-program-kernel-space">1. XDP Program (Kernel Space)</a></li>
<li><a class="reference internal" href="#backend-pool-management-user-space">2. Backend Pool Management (User Space)</a></li>
<li><a class="reference internal" href="#configuration-interface">3. Configuration Interface</a></li>
</ul>
</li>
<li><a class="reference internal" href="#implementation-building-the-xdp-load-balancer">Implementation: Building the XDP Load Balancer</a><ul>
<li><a class="reference internal" href="#user-space-controller">User-Space Controller</a></li>
<li><a class="reference internal" href="#build-script">Build Script</a></li>
</ul>
</li>
<li><a class="reference internal" href="#performance-testing-speed-of-light-networking">Performance Testing: Speed of Light Networking</a><ul>
<li><a class="reference internal" href="#test-environment-setup">Test Environment Setup</a></li>
<li><a class="reference internal" href="#benchmark-results">Benchmark Results</a></li>
<li><a class="reference internal" href="#real-world-testing-script">Real-World Testing Script</a></li>
</ul>
</li>
<li><a class="reference internal" href="#advanced-features-beyond-basic-load-balancing">Advanced Features: Beyond Basic Load Balancing</a><ul>
<li><a class="reference internal" href="#sticky-sessions">1. Sticky Sessions</a></li>
<li><a class="reference internal" href="#health-checking">2. Health Checking</a></li>
<li><a class="reference internal" href="#multi-queue-support">3. Multi-Queue Support</a></li>
</ul>
</li>
<li><a class="reference internal" href="#pitfalls-limitations-the-reality-check">Pitfalls &amp; Limitations: The Reality Check</a><ul>
<li><a class="reference internal" href="#limited-protocol-support">1. Limited Protocol Support</a></li>
<li><a class="reference internal" href="#debugging-complexity">2. Debugging Complexity</a></li>
<li><a class="reference internal" href="#kernel-dependencies">3. Kernel Dependencies</a></li>
<li><a class="reference internal" href="#memory-constraints">4. Memory Constraints</a></li>
</ul>
</li>
<li><a class="reference internal" href="#when-not-to-use-xdp-load-balancing">When NOT to Use XDP Load Balancing</a></li>
<li><a class="reference internal" href="#production-deployment-considerations">Production Deployment Considerations</a><ul>
<li><a class="reference internal" href="#monitoring-and-observability">Monitoring and Observability</a></li>
<li><a class="reference internal" href="#graceful-deployment">Graceful Deployment</a></li>
</ul>
</li>
<li><a class="reference internal" href="#the-bottom-line-when-speed-is-everything">The Bottom Line: When Speed is Everything</a></li>
</ul>
</li>
</ul>

      </div>
    </div>
   
    
  </div>

    </aside>
  </div>
</div><script src="../_static/jquery.js?v=5d32c60e"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
    <script src="../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/scripts/furo.js?v=5fa4622c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script src="../_static/header-nav.js?v=e117ad08"></script>
    
<script>
  const github_url = "https://github.com/ngkore";
</script>
</body>
</html>